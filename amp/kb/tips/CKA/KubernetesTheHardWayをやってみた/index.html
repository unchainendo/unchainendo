<!DOCTYPE html>
<html ⚡ lang="ja">
    <head>
        

        <meta charset="utf-8" />
        <script async src="https://cdn.ampproject.org/v0.js"></script>
        <title>Kubernetes The Hard Wayをやってみた | YuKB</title>
        
            <link rel="canonical" href="https://unchainendo.github.io/unchainendo/kb/tips/CKA/KubernetesTheHardWay%E3%82%92%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F/" />
        
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />

        
        

        <script type="application/ld+json">
            {
                "@context": "http://schema.org",
                "@type": "NewsArticle",
                "mainEntityOfPage": {
                    "@type": "WebPage",
                    "@id": "https:\/\/unchainendo.github.io\/unchainendo\/kb\/tips\/CKA\/KubernetesTheHardWay%E3%82%92%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F\/"
                },
                "headline": "Kubernetes The Hard Wayをやってみた",
                
                "datePublished": "2020-04-30T00:00:00"},
                "author": {
                    "@type": "Person",
                    "name": "UNCHAIN-ENDO"
                },
                "publisher": {
                    "name": "YuKB",
                    "logo": {
                      "@type": "ImageObject",
                      "url": ""
                }
            }
        </script>
        <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
        
        
        
        <style amp-custom>;@font-face{font-family:yu gothic;src:local("Yu Gothic Medium");font-weight:100}@font-face{font-family:yu gothic;src:local("Yu Gothic Medium");font-weight:200}@font-face{font-family:yu gothic;src:local("Yu Gothic Medium");font-weight:300}@font-face{font-family:yu gothic;src:local("Yu Gothic Medium");font-weight:400}@font-face{font-family:yu gothic;src:local("Yu Gothic Bold");font-weight:700}@font-face{font-family:helvetica neue;src:local("Helvetica Neue Regular");font-weight:100}@font-face{font-family:helvetica neue;src:local("Helvetica Neue Regular");font-weight:200}@font-face{font-family:myyugothicm;font-weight:100;src:local("YuGothic-Light"),local("Yu Gothic Light")}@font-face{font-family:myyugothicm;font-weight:200;src:local("YuGothic-Light"),local("Yu Gothic Light")}@font-face{font-family:myyugothicm;font-weight:300;src:local("YuGothic-Regular"),local("Yu Gothic")}@font-face{font-family:myyugothicm;font-weight:400;src:local("YuGothic-Medium"),local("Yu Gothic Medium"),local("YuGothic-Regular")}@font-face{font-family:myyugothicm;font-weight:500;src:local("YuGothic-Medium"),local("Yu Gothic Medium"),local("YuGothic-Regular")}@font-face{font-family:myyugothicm;font-weight:600;src:local("YuGothic-Bold"),local("Yu Gothic")}@font-face{font-family:myyugothicm;font-weight:700;src:local("YuGothic-Bold"),local("Yu Gothic")}@font-face{font-family:myyugothicm;font-weight:800;src:local("YuGothic-Bold"),local("Yu Gothic")}@font-face{font-family:myyugothicm;font-weight:900;src:local("YuGothic-Bold"),local("Yu Gothic")}body{font-family:-apple-system,BlinkMacSystemFont,helvetica neue,biz udpゴシック,BIZ-UDPGothic,ud digi kyokasho n-r,hiragino kaku gothic pron,noto sans jp,MyYuGothicM,Verdana,Meiryo,"m+ 1p",sans-serif;font-feature-settings:"palt" 1}.m-paginator__list-item-link,.m-paginator__list-item-link--current,.m-logo__link,.a-breadcrumbs__list-item-link{text-decoration:none}.chroma{color:#f8f8f2;background-color:#272822;max-height:400px;overflow-y:scroll}.chroma .err{color:#960050;background-color:#1e0010}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#66d9ef}.chroma .kc{color:#66d9ef}.chroma .kd{color:#66d9ef}.chroma .kn{color:#f92672}.chroma .kp{color:#66d9ef}.chroma .kr{color:#66d9ef}.chroma .kt{color:#66d9ef}.chroma .na{color:#a6e22e}.chroma .nc{color:#a6e22e}.chroma .no{color:#66d9ef}.chroma .nd{color:#a6e22e}.chroma .ne{color:#a6e22e}.chroma .nf{color:#a6e22e}.chroma .nx{color:#a6e22e}.chroma .nt{color:#f92672}.chroma .l{color:#ae81ff}.chroma .ld{color:#e6db74}.chroma .s{color:#e6db74}.chroma .sa{color:#e6db74}.chroma .sb{color:#e6db74}.chroma .sc{color:#e6db74}.chroma .dl{color:#e6db74}.chroma .sd{color:#e6db74}.chroma .s2{color:#e6db74}.chroma .se{color:#ae81ff}.chroma .sh{color:#e6db74}.chroma .si{color:#e6db74}.chroma .sx{color:#e6db74}.chroma .sr{color:#e6db74}.chroma .s1{color:#e6db74}.chroma .ss{color:#e6db74}.chroma .m{color:#ae81ff}.chroma .mb{color:#ae81ff}.chroma .mf{color:#ae81ff}.chroma .mh{color:#ae81ff}.chroma .mi{color:#ae81ff}.chroma .il{color:#ae81ff}.chroma .mo{color:#ae81ff}.chroma .o{color:#f92672}.chroma .ow{color:#f92672}.chroma .c{color:#75715e}.chroma .ch{color:#75715e}.chroma .cm{color:#75715e}.chroma .c1{color:#75715e}.chroma .cs{color:#75715e}.chroma .cp{color:#75715e}.chroma .cpf{color:#75715e}.chroma .gd{color:#f92672}.chroma .ge{font-style:italic}.chroma .gi{color:#a6e22e}.chroma .gs{font-weight:700}.chroma .gu{color:#75715e}.a-copy-right{display:block;padding:2rem}.a-breadcrumbs__list{flex-wrap:wrap;list-style:none;margin:0;padding:0}.a-breadcrumbs__list-item{display:inline-block;white-space:nowrap}.a-breadcrumbs__list-item-link{font-size:.875rem}.a-breadcrumbs__list-item-link,.a-breadcrumbs__list-item-link:active,.a-breadcrumbs__list-item-link:hover,.a-breadcrumbs__list-item-link:visited{color:#212529}.a-breadcrumbs__list-item-link:hover{color:#0056b3;text-decoration:underline}.a-breadcrumbs__list-item-link-gt{padding-left:.5rem;padding-right:.5rem}.m-logo{padding:2rem}.m-logo__link{font-size:2rem}.m-logo__link,.m-logo__link:active,.m-logo__link:hover,.m-logo__link:visited{color:#212529}.m-global-menu{display:flex}.m-global-menu__navigation{display:flex}.m-global-menu__navigation-list{display:flex;align-items:baseline;padding:0;margin:0;list-style:none}.m-global-menu__navigation-list-item{display:flex;align-items:baseline;margin:0;padding:1rem}.m-global-menu__navigation-list-item-link,.m-global-menu__navigation-list-item-link--active{display:block;font-weight:400}.m-global-menu__navigation-list-item-link,.m-global-menu__navigation-list-item-link--active,.m-global-menu__navigation-list-item-link:active,.m-global-menu__navigation-list-item-link:hover,.m-global-menu__navigation-list-item-link:visited{text-decoration:none;color:#212529}.m-global-menu__navigation-list-item-link--active{font-weight:700}.m-global-menu__navigation-list-item-link--active,.m-global-menu__navigation-list-item-link--active:active,.m-global-menu__navigation-list-item-link--active:hover,.m-global-menu__navigation-list-item-link--active:visited{text-decoration:none;border-bottom:2px solid #212529}.m-global-menu__navigation-list-item-link:hover,.m-global-menu__navigation-list-item-link--active:hover{color:#0056b3}.m-body{display:block;width:100%}.m-global-header{display:flex;align-items:baseline;max-width:1260px;margin-left:auto;margin-right:auto;height:100px}@media screen and (max-width:1024px){.m-global-header{flex-direction:column;align-items:center;height:auto}}.m-main{display:block;max-width:1260px;margin-left:auto;margin-right:auto}.m-main-container{display:flex}@media screen and (max-width:1024px){.m-main-container{flex-direction:column}}.m-content-container{width:auto}.m-aside-container{flex-shrink:0;width:400px}@media screen and (max-width:1024px){.m-aside-container{width:auto}}.m-global-footer{display:block;max-width:1260px;margin-left:auto;margin-right:auto}.m-entry{padding:2rem}.m-entry__breadcrumbs{padding-bottom:2rem}.m-entry__header{padding-bottom:2rem}.m-entry__header-taxonomies{display:flex}.m-entry__header-taxonomies-category{padding-right:1rem}.m-entry__header-taxonomies-category-title-link,.m-entry__header-taxonomies-category-title-link:active,.m-entry__header-taxonomies-category-title-link:hover,.m-entry__header-taxonomies-category-title-link:visited{text-decoration:none;color:#212529}.m-entry__header-taxonomies-category-title-link:hover{color:#0056b3;text-decoration:underline}.m-entry__header-taxonomies-category-title-link::before{font-family:"font awesome 5 free";content:"";-webkit-font-smoothing:antialiased;display:inline-block;text-rendering:auto;line-height:1;font-weight:800;padding-right:5px}.m-entry__header-taxonomies-tags-list{display:flex;list-style:none;padding:0}.m-entry__header-taxonomies-tags-list-item{padding-right:1rem}.m-entry__header-taxonomies-tags-list-item-link,.m-entry__header-taxonomies-tags-list-item-link:active,.m-entry__header-taxonomies-tags-list-item-link:hover,.m-entry__header-taxonomies-tags-list-item-link:visited{text-decoration:none;color:#212529}.m-entry__header-taxonomies-tags-list-item-link:hover{color:#0056b3;text-decoration:underline}.m-entry__header-taxonomies-tags-list-item-link::before{font-family:"font awesome 5 free";content:"";-webkit-font-smoothing:antialiased;display:inline-block;text-rendering:auto;line-height:1;font-weight:800;padding-right:5px}.m-entry__header-title-link,.m-entry__header-title-link:active,.m-entry__header-title-link:hover,.m-entry__header-title-link:visited{text-decoration:none;color:#212529}.m-entry__header-title-link-text{font-size:2rem;padding-top:1rem;padding-bottom:1rem}.m-entry__header-eyecache{padding-top:1rem}.m-entry__header-eyecache-img{width:100%}.m-entry__footer{padding:1rem}.m-entry__footer-sns-buttons{display:flex;justify-content:center;width:100%;padding-bottom:1rem}.m-entry__footer-sns-buttons-icon,.m-entry__footer-sns-buttons-icon-hatebu{display:block;padding-right:1rem;font-size:1.5rem;line-height:1rem}.m-entry__footer-sns-buttons-icon,.m-entry__footer-sns-buttons-icon-hatebu,.m-entry__footer-sns-buttons-icon:active,.m-entry__footer-sns-buttons-icon:hover,.m-entry__footer-sns-buttons-icon:visited{text-decoration:none;color:#212529}.m-entry__footer-sns-buttons-icon:hover,.m-entry__footer-sns-buttons-icon-hatebu:hover{color:#0056b3}.m-entry__footer-sns-buttons-icon-hatebu{position:relative;top:4px;font-family:Verdana;font-weight:700}.m-entry__page-navigation{display:flex;justify-content:center;padding-bottom:2rem}.m-entry__page-navigation-link{padding-right:1rem}.m-entry__page-navigation-link,.m-entry__page-navigation-link:active,.m-entry__page-navigation-link:hover,.m-entry__page-navigation-link:visited{text-decoration:none;color:#212529}.m-entry__page-navigation-link:hover{color:#0056b3}.m-entry__content{line-height:170%}.m-entry__content h2{padding-top:2rem;padding-bottom:1rem}.m-entry__content h3{padding-top:1rem;padding-bottom:1rem}.m-entry__content img{width:100%}.m-entry__content code{background-color:#eee;padding-left:2px;padding-right:2px;font-weight:400;border-radius:4px}.m-entry__content pre{padding:1rem}.m-entry__content .highlight pre code{padding:0;background-color:transparent}.m-entry__content table{margin:1rem;width:100%;border-collapse:collapse}.m-entry__content table tr th{padding:.5rem;border:1px solid #ccc;background-color:#ccc}.m-entry__content table tr td{padding:.5rem;border:1px solid #ccc}.m-entry__content blockquote{padding:1rem;margin:2rem;border-left:3px solid #ccc}.m-entry__content a[target=_blank]::after{font-family:"font awesome 5 free";content:"";-webkit-font-smoothing:antialiased;display:inline-block;text-rendering:auto;line-height:1;font-weight:800;margin-left:5px;margin-right:3px;display:inline-block}.m-list__breadcrumbs{padding-top:2rem;padding-left:2rem;padding-right:2rem}.m-paginator{padding-left:2rem;padding-right:2rem}.m-paginator__list{display:flex;justify-content:center;list-style:none;margin:0;padding:0}.m-paginator__list-item{display:block;padding:.5rem}.m-paginator__list-item-link,.m-paginator__list-item-link--current,.m-paginator__list-item-link:active,.m-paginator__list-item-link:hover,.m-paginator__list-item-link:visited{color:#212529}.m-paginator__list-item-link:hover,.m-paginator__list-item-link--current:hover{color:#0056b3}.m-paginator__list-item-link--current{font-weight:700}.m-paginator__list-item-link--current,.m-paginator__list-item-link--current:active,.m-paginator__list-item-link--current:hover,.m-paginator__list-item-link--current:visited{text-decoration:none;border-bottom:2px solid #212529}.m-aside-container{padding:1rem}.m-aside-widget,.m-aside-widget__tags,.m-aside-widget__category,.m-aside-widget__profile{padding:1rem}.m-aside-widget__profile-avatar{text-align:center}.m-aside-widget__profile-avatar-img{border-radius:30rem}.m-aside-widget__profile-author{padding:1rem;text-align:center}.m-aside-widget__category-list{list-style:none}.m-aside-widget__category-list-item{padding-bottom:.5rem}.m-aside-widget__category-list-item-link,.m-aside-widget__category-list-item-link:active,.m-aside-widget__category-list-item-link:hover,.m-aside-widget__category-list-item-link:visited{text-decoration:none;color:#212529}.m-aside-widget__category-list-item-link:hover{color:#0056b3;text-decoration:underline}.m-aside-widget__category-list-item-link::before{font-family:"font awesome 5 free";content:"";-webkit-font-smoothing:antialiased;display:inline-block;text-rendering:auto;line-height:1;font-weight:800;padding-right:5px}.m-aside-widget__category>.m-aside-widget__category-list{padding:0}.m-aside-widget__tags-list{list-style:none}.m-aside-widget__tags-list-item{padding-bottom:.5rem}.m-aside-widget__tags-list-item-link,.m-aside-widget__tags-list-item-link:active,.m-aside-widget__tags-list-item-link:hover,.m-aside-widget__tags-list-item-link:visited{text-decoration:none;color:#212529}.m-aside-widget__tags-list-item-link:hover{color:#0056b3;text-decoration:underline}.m-aside-widget__tags-list-item-link::before{font-family:"font awesome 5 free";content:"";-webkit-font-smoothing:antialiased;display:inline-block;text-rendering:auto;line-height:1;font-weight:800;padding-right:5px}.m-aside-widget__tags>.m-aside-widget__tags-list{padding:0}</style>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    </head>
    <body>
        <header class="m-global-header">
            <div class="m-logo">
                <a class="m-logo__link" href="/" >YuKB</a>
            </div>
        </header>
        <main class="m-main">
            <div class="m-main-container">
                <div class="m-content-container">
                    
    <article class="m-entry" >
        <div class="m-entry__header">
            <div class="m-entry__header-category">
                <span class="m-entry__header-category-title">
                    CKA
                </span>
            </div>
            <div class="m-entry__header-title">
                <a class="m-entry__header-title-link" href="https://unchainendo.github.io/unchainendo/amp/kb/tips/CKA/KubernetesTheHardWay%E3%82%92%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F/" >
                    <h1 class="m-entry__header-title-link-text">Kubernetes The Hard Wayをやってみた</h1>
                </a>
            </div>
            <div class="m-entry__header-date">
                <time>2020/04/30</time>
            </div>

            
            
        </div>
        <div class="m-entry__content">
            <h3 id="概略">概略</h3>
<h4 id="gcp利用料金">GCP利用料金</h4>
<p>毎時$0.23(一日あたり$5.46)
GCP登録時に付与される$300で学習しきれば実質無料。
<a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">Kubernetes The Hard Way</a></p>
<h4 id="k8sクラスタの詳細">k8sクラスタの詳細</h4>
<p>2020年4月時点では以下のバージョン</p>
<ul>
<li>kubernetes 1.15.3</li>
<li>containerd 1.2.9</li>
<li>coredns v1.6.3</li>
<li>cni v0.7.1</li>
<li>etcd v3.4.0</li>
</ul>
<h3 id="kubernetes-the-hard-way">Kubernetes The Hard Way</h3>
<h4 id="prerequisites">Prerequisites</h4>
<p>Google Cloud SDKをインストールする。<br>
リンク先からOSに合ったモジュールを選択してダウンロードし、あとは以下の流れでインストールする。
参照: <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># tarアーカイブの展開</span>
$ tar -zxvf google-cloud-sdk-280.0.0-darwin-x86_64.tar.gz
x google-cloud-sdk/
x google-cloud-sdk/properties
x google-cloud-sdk/lib/
x google-cloud-sdk/lib/third_party/
x google-cloud-sdk/lib/third_party/apitools/
x google-cloud-sdk/lib/third_party/apitools/base/
x google-cloud-sdk/lib/third_party/apitools/base/py/
x google-cloud-sdk/lib/third_party/apitools/base/py/__init__.py
x google-cloud-sdk/lib/third_party/apitools/base/py/all.py

<span class="o">(</span>後略<span class="o">)</span>

<span class="c1"># インストーラを実行</span>
$ ./google-cloud-sdk/install.sh
Welcome to the Google Cloud SDK!

To <span class="nb">help</span> improve the quality of this product, we collect anonymized usage data
and anonymized stacktraces when crashes are encountered<span class="p">;</span> additional information
is available at &lt;https://cloud.google.com/sdk/usage-statistics&gt;. This data is
handled in accordance with our privacy policy
&lt;https://policies.google.com/privacy&gt;. You may choose to opt in this
collection now <span class="o">(</span>by choosing <span class="s1">&#39;Y&#39;</span> at the below prompt<span class="o">)</span>, or at any <span class="nb">time</span> in the
future by running the following command:

    gcloud config <span class="nb">set</span> disable_usage_reporting <span class="nb">false</span>

Do you want to <span class="nb">help</span> improve the Google Cloud SDK <span class="o">(</span>y/N<span class="o">)</span>?  y


Your current Cloud SDK version is: 280.0.0
The latest available version is: 286.0.0

┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                   Components                                                  │
├──────────────────┬──────────────────────────────────────────────────────┬──────────────────────────┬──────────┤
│      Status      │                         Name                         │            ID            │   Size   │
├──────────────────┼──────────────────────────────────────────────────────┼──────────────────────────┼──────────┤
│ Update Available │ BigQuery Command Line Tool                           │ bq                       │  &lt; <span class="m">1</span> MiB │
│ Update Available │ Cloud SDK Core Libraries                             │ core                     │ 14.1 MiB │
│ Update Available │ Cloud Storage Command Line Tool                      │ gsutil                   │  3.6 MiB │
│ Not Installed    │ App Engine Go Extensions                             │ app-engine-go            │  4.8 MiB │
│ Not Installed    │ Appctl                                               │ appctl                   │ 17.5 MiB │
│ Not Installed    │ Cloud Bigtable Command Line Tool                     │ cbt                      │  7.6 MiB │
│ Not Installed    │ Cloud Bigtable Emulator                              │ bigtable                 │  6.6 MiB │
│ Not Installed    │ Cloud Datalab Command Line Tool                      │ datalab                  │  &lt; <span class="m">1</span> MiB │
│ Not Installed    │ Cloud Datastore Emulator                             │ cloud-datastore-emulator │ 18.4 MiB │
│ Not Installed    │ Cloud Firestore Emulator                             │ cloud-firestore-emulator │ 40.3 MiB │
│ Not Installed    │ Cloud Pub/Sub Emulator                               │ pubsub-emulator          │ 34.9 MiB │
│ Not Installed    │ Cloud SQL Proxy                                      │ cloud_sql_proxy          │  3.7 MiB │
│ Not Installed    │ Emulator Reverse Proxy                               │ emulator-reverse-proxy   │ 14.5 MiB │
│ Not Installed    │ Google Cloud Build Local Builder                     │ cloud-build-local        │  5.9 MiB │
│ Not Installed    │ Google Container Registry<span class="err">&#39;</span>s Docker credential helper │ docker-credential-gcr    │  1.8 MiB │
│ Not Installed    │ Kind                                                 │ kind                     │  4.4 MiB │
│ Not Installed    │ Minikube                                             │ minikube                 │ 21.9 MiB │
│ Not Installed    │ Skaffold                                             │ skaffold                 │ 12.9 MiB │
│ Not Installed    │ anthos-auth                                          │ anthos-auth              │  8.6 MiB │
│ Not Installed    │ gcloud Alpha Commands                                │ alpha                    │  &lt; <span class="m">1</span> MiB │
│ Not Installed    │ gcloud Beta Commands                                 │ beta                     │  &lt; <span class="m">1</span> MiB │
│ Not Installed    │ gcloud app Java Extensions                           │ app-engine-java          │ 62.3 MiB │
│ Not Installed    │ gcloud app PHP Extensions                            │ app-engine-php           │ 21.9 MiB │
│ Not Installed    │ gcloud app Python Extensions                         │ app-engine-python        │  6.1 MiB │
│ Not Installed    │ gcloud app Python Extensions <span class="o">(</span>Extra Libraries<span class="o">)</span>       │ app-engine-python-extras │ 27.1 MiB │
│ Not Installed    │ kpt                                                  │ kpt                      │ 18.8 MiB │
│ Not Installed    │ kubectl                                              │ kubectl                  │  &lt; <span class="m">1</span> MiB │
└──────────────────┴──────────────────────────────────────────────────────┴──────────────────────────┴──────────┘
To install or remove components at your current SDK version <span class="o">[</span>280.0.0<span class="o">]</span>, run:
  $ gcloud components install COMPONENT_ID
  $ gcloud components remove COMPONENT_ID

To update your SDK installation to the latest version <span class="o">[</span>286.0.0<span class="o">]</span>, run:
  $ gcloud components update


Modify profile to update your <span class="nv">$PATH</span> and <span class="nb">enable</span> shell <span class="nb">command</span>
completion?

Do you want to <span class="k">continue</span> <span class="o">(</span>Y/n<span class="o">)</span>?  y

The Google Cloud SDK installer will now prompt you to update an rc
file to bring the Google Cloud CLIs into your environment.

Enter a path to an rc file to update, or leave blank to use
<span class="o">[</span>/Users/yuendo/.bash_profile<span class="o">]</span>:
Backing up <span class="o">[</span>/Users/yuendo/.bash_profile<span class="o">]</span> to <span class="o">[</span>/Users/yuendo/.bash_profile.backup<span class="o">]</span>.
<span class="o">[</span>/Users/yuendo/.bash_profile<span class="o">]</span> has been updated.

<span class="o">==</span>&gt; Start a new shell <span class="k">for</span> the changes to take effect.


For more information on how to get started, please visit:
  https://cloud.google.com/sdk/docs/quickstarts

<span class="c1"># bash_profileが書き換わったので読み込む</span>
$ . ~/.bash_profile

<span class="c1"># 初期化を実行</span>
<span class="c1"># 最後にプロジェクトの選択肢が表示されるので初期状態で作成されているプロジェクトを選択</span>
$ ./google-cloud-sdk/bin/gcloud init
Welcome! This <span class="nb">command</span> will take you through the configuration of gcloud.

Your current configuration has been <span class="nb">set</span> to: <span class="o">[</span>default<span class="o">]</span>

You can skip diagnostics next <span class="nb">time</span> by using the following flag:
  gcloud init --skip-diagnostics

Network diagnostic detects and fixes <span class="nb">local</span> network connection issues.
Checking network connection...done.
Reachability Check passed.
Network diagnostic passed <span class="o">(</span>1/1 checks passed<span class="o">)</span>.

You must log in to <span class="k">continue</span>. Would you like to log in <span class="o">(</span>Y/n<span class="o">)</span>?  y

Your browser has been opened to visit:

    https://accounts.google.com/o/oauth2/auth?code_challenge<span class="o">=</span>xxxxxxxxxxxxxxxxxx

Updates are available <span class="k">for</span> some Cloud SDK components.  To install them,
please run:
  $ gcloud components update

You are logged in as: <span class="o">[</span>xxxxxxxxxxxxx@gmail.com<span class="o">]</span>.

Pick cloud project to use:
 <span class="o">[</span>1<span class="o">]</span> rising-capsule-272923
 <span class="o">[</span>2<span class="o">]</span> Create a new project
Please enter numeric choice or text value <span class="o">(</span>must exactly match list
item<span class="o">)</span>:  <span class="m">1</span>

Your current project has been <span class="nb">set</span> to: <span class="o">[</span>rising-capsule-272923<span class="o">]</span>.

Not setting default zone/region <span class="o">(</span>this feature makes it easier to use
<span class="o">[</span>gcloud compute<span class="o">]</span> by setting an appropriate default value <span class="k">for</span> the
--zone and --region flag<span class="o">)</span>.
See https://cloud.google.com/compute/docs/gcloud-compute section on how to <span class="nb">set</span>
default compute region and zone manually. If you would like <span class="o">[</span>gcloud init<span class="o">]</span> to be
able to <span class="k">do</span> this <span class="k">for</span> you the next <span class="nb">time</span> you run it, make sure the
Compute Engine API is enabled <span class="k">for</span> your project on the
https://console.developers.google.com/apis page.

Created a default .boto configuration file at <span class="o">[</span>/Users/yuendo/.boto<span class="o">]</span>. See this file and
<span class="o">[</span>https://cloud.google.com/storage/docs/gsutil/commands/config<span class="o">]</span> <span class="k">for</span> more
information about configuring Google Cloud Storage.
Your Google Cloud SDK is configured and ready to use!

* Commands that require authentication will use xxxxxxxxx@gmail.com by default
* Commands will reference project <span class="sb">`</span>rising-capsule-272923<span class="sb">`</span> by default
Run <span class="sb">`</span>gcloud <span class="nb">help</span> config<span class="sb">`</span> to learn how to change individual settings

This gcloud configuration is called <span class="o">[</span>default<span class="o">]</span>. You can create additional configurations <span class="k">if</span> you work with multiple accounts and/or projects.
Run <span class="sb">`</span>gcloud topic configurations<span class="sb">`</span> to learn more.

Some things to try next:

* Run <span class="sb">`</span>gcloud --help<span class="sb">`</span> to see the Cloud Platform services you can interact with. And run <span class="sb">`</span>gcloud <span class="nb">help</span> COMMAND<span class="sb">`</span> to get <span class="nb">help</span> on any gcloud command.
* Run <span class="sb">`</span>gcloud topic --help<span class="sb">`</span> to learn about advanced features of the SDK like arg files and output formatting
</code></pre></td></tr></table>
</div>
</div><p>最後にGoogle Cloud SDKのバージョンが<code>262.0.0</code>より高いことを確認する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ gcloud version
Google Cloud SDK 280.0.0
bq 2.0.53
core 2020.02.07
gsutil 4.47
Updates are available <span class="k">for</span> some Cloud SDK components.  To install them,
please run:
  $ gcloud components update

</code></pre></td></tr></table>
</div>
</div><p>次にCompute RegionとZoneを設定する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Regionの設定</span>
$ gcloud config <span class="nb">set</span> compute/region us-west1
Updated property <span class="o">[</span>compute/region<span class="o">]</span>.
<span class="c1"># Zoneの設定</span>
$ gcloud config <span class="nb">set</span> compute/zone us-west1-c
Updated property <span class="o">[</span>compute/zone<span class="o">]</span>.
</code></pre></td></tr></table>
</div>
</div><p>最後にtmuxを使うと便利だよという章がある。<br>
試験でも使えるので慣れておくことにした。</p>
<h4 id="installing-the-client-tools">Installing the Client Tools</h4>
<p>必要なコマンドラインツールを導入する。<br>
まずは<code>cfssl</code>と<code>cfssljson</code>の導入。
<code>cfssl</code>はjsonで書いた定義を読み込んで秘密鍵、CSRをjson形式で吐き出してくれる。
<code>cfssljson</code>はjson形式で出力されたものから秘密鍵とCSRを生成してくれる。
TLS証明書まわりの運用を自動化する際にもよく使われている模様。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># curlでモジュールをダウンロード</span>
$ curl -o cfssl https://storage.googleapis.com/kubernetes-the-hard-way/cfssl/darwin/cfssl
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Dload  Upload   Total   Spent    Left  Speed
<span class="m">100</span> 23.2M  <span class="m">100</span> 23.2M    <span class="m">0</span>     <span class="m">0</span>  4428k      <span class="m">0</span>  0:00:05  0:00:05 --:--:-- 4769k
$ curl -o cfssljson https://storage.googleapis.com/kubernetes-the-hard-way/cfssl/darwin/cfssljson
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Dload  Upload   Total   Spent    Left  Speed
<span class="m">100</span> 13.8M  <span class="m">100</span> 13.8M    <span class="m">0</span>     <span class="m">0</span>  3692k      <span class="m">0</span>  0:00:03  0:00:03 --:--:-- 3691k

<span class="c1"># 実行権限付けて/usr/local/binに移動</span>
$ ls -l cfssl cfssljson
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">24380648</span>  <span class="m">4</span>  <span class="m">1</span> 12:46 cfssl
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">14483124</span>  <span class="m">4</span>  <span class="m">1</span> 12:46 cfssljson
$ chmod +x cfssl cfssljson
$ ls -l cfssl cfssljson
-rwxr-xr-x  <span class="m">1</span> yuendo  staff  <span class="m">24380648</span>  <span class="m">4</span>  <span class="m">1</span> 12:46 cfssl
-rwxr-xr-x  <span class="m">1</span> yuendo  staff  <span class="m">14483124</span>  <span class="m">4</span>  <span class="m">1</span> 12:46 cfssljson
$ sudo mv cfssl cfssljson /usr/local/bin/
Password:
$ ls -l /usr/local/bin/cfssl /usr/local/bin/cfssljson
-rwxr-xr-x  <span class="m">1</span> yuendo  staff  <span class="m">24380648</span>  <span class="m">4</span>  <span class="m">1</span> 12:46 /usr/local/bin/cfssl
-rwxr-xr-x  <span class="m">1</span> yuendo  staff  <span class="m">14483124</span>  <span class="m">4</span>  <span class="m">1</span> 12:46 /usr/local/bin/cfssljson

<span class="c1"># バージョン確認</span>
$ cfssl version
Version: 1.3.4
Revision: dev
Runtime: go1.13
$ cfssljson --version
Version: 1.3.4
Revision: dev
Runtime: go1.13
</code></pre></td></tr></table>
</div>
</div><p>次にkubectlをインストールする。<br>
これがないと始まらないね。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># curlでモジュールをダウンロード</span>
$ curl -o kubectl https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/darwin/amd64/kubectl
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Dload  Upload   Total   Spent    Left  Speed
<span class="m">100</span> 46.3M  <span class="m">100</span> 46.3M    <span class="m">0</span>     <span class="m">0</span>  2784k      <span class="m">0</span>  0:00:17  0:00:17 --:--:-- 2963k

<span class="c1"># 実行権限付けて/usr/local/binに移動</span>
$ ls -l ./kubectl
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">48591088</span>  <span class="m">4</span>  <span class="m">4</span> 15:11 ./kubectl
$ chmod +x ./kubectl
$ ls -l ./kubectl
-rwxr-xr-x  <span class="m">1</span> yuendo  staff  <span class="m">48591088</span>  <span class="m">4</span>  <span class="m">4</span> 15:11 ./kubectl
$ sudo mv kubectl /usr/local/bin/
Password:
$ ls -l /usr/local/bin/kubectl
-rwxr-xr-x  <span class="m">1</span> yuendo  staff  <span class="m">48591088</span>  <span class="m">4</span>  <span class="m">4</span> 15:11 /usr/local/bin/kubectl

<span class="c1"># バージョン確認</span>
$ kubectl version --client
Client Version: version.Info<span class="o">{</span>Major:<span class="s2">&#34;1&#34;</span>, Minor:<span class="s2">&#34;15&#34;</span>, GitVersion:<span class="s2">&#34;v1.15.3&#34;</span>, GitCommit:<span class="s2">&#34;2d3c76f9091b6bec110a5e63777c332469e0cba2&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, BuildDate:<span class="s2">&#34;2019-08-19T11:13:54Z&#34;</span>, GoVersion:<span class="s2">&#34;go1.12.9&#34;</span>, Compiler:<span class="s2">&#34;gc&#34;</span>, Platform:<span class="s2">&#34;darwin/amd64&#34;</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="privisioning-compute-resources">Privisioning Compute Resources</h4>
<p>Kubernetesクラスタを稼働させるために必要なコンピュートリソースをプロビジョニングする。</p>
<p>まずはネットワーク環境の整備ということで、Virtual Private Cloud(VPC)ネットワークをセットアップする。
VPCネットワーク名は<code>kubernetes-the-hard-way</code>とする。
VPCネットワークを作成したら、そこにKubernetesクラスタ用のサブネット(<code>kubernetes</code>)を作成する。
各ノードのIPアドレスをアサインできるだけの十分なアドレスレンジを確保しておく。
今回はサブネットマスク24bitとした。
VPCネットワーク作成時にfirewallの設定例のコマンドまで教えてくれてとても丁寧。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># VPCネットワークの作成</span>
$ gcloud compute networks create kubernetes-the-hard-way --subnet-mode custom
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/networks/kubernetes-the-hard-way<span class="o">]</span>.
NAME                     SUBNET_MODE  BGP_ROUTING_MODE  IPV4_RANGE  GATEWAY_IPV4
kubernetes-the-hard-way  CUSTOM       REGIONAL

Instances on this network will not be reachable <span class="k">until</span> firewall rules
are created. As an example, you can allow all internal traffic between
instances as well as SSH, RDP, and ICMP by running:

$ gcloud compute firewall-rules create &lt;FIREWALL_NAME&gt; --network kubernetes-the-hard-way --allow tcp,udp,icmp --source-ranges &lt;IP_RANGE&gt;
$ gcloud compute firewall-rules create &lt;FIREWALL_NAME&gt; --network kubernetes-the-hard-way --allow tcp:22,tcp:3389,icmp



Updates are available <span class="k">for</span> some Cloud SDK components.  To install them,
please run:
$ gcloud components update

<span class="c1"># VPCネットワークにサブネットを作成</span>
$ gcloud compute networks subnets create kubernetes <span class="se">\
</span><span class="se"></span>&gt; --network kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt; --range 10.240.0.0/24
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/subnetworks/kubernetes<span class="o">]</span>.
NAME        REGION    NETWORK                  RANGE
kubernetes  us-west1  kubernetes-the-hard-way  10.240.0.0/24
</code></pre></td></tr></table>
</div>
</div><p>次にファイアウォールの設定。
内部のネットワークは全プロトコルを許可、外からはSSH、ICMP、HTTPSを許可する。
Kubernetes API Serverが使用するHTTPSポートは6443。
内部で<code>10.200.0.0/16</code>からの通信を許可しているのはなぜだろう。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 内部通信用のfirewall設定</span>
$ gcloud compute firewall-rules create kubernetes-the-hard-way-allow-internal <span class="se">\
</span><span class="se"></span>&gt; --allow tcp,udp,icmp <span class="se">\
</span><span class="se"></span>&gt; --network kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt; --source-ranges 10.240.0.0/24,10.200.0.0/16
Creating firewall...⠧Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-internal<span class="o">]</span>.
Creating firewall...done.
NAME                                    NETWORK                  DIRECTION  PRIORITY  ALLOW         DENY  DISABLED
kubernetes-the-hard-way-allow-internal  kubernetes-the-hard-way  INGRESS    <span class="m">1000</span>      tcp,udp,icmp        False

<span class="c1"># 外部通信用のfirewall設定</span>
$ gcloud compute firewall-rules create kubernetes-the-hard-way-allow-external <span class="se">\
</span><span class="se"></span>&gt; --allow tcp:22,tcp:6443,icmp <span class="se">\
</span><span class="se"></span>&gt; --network kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt; --source-ranges 0.0.0.0/0
Creating firewall...⠶Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-external<span class="o">]</span>.
Creating firewall...done.
NAME                                    NETWORK                  DIRECTION  PRIORITY  ALLOW                 DENY  DISABLED
kubernetes-the-hard-way-allow-external  kubernetes-the-hard-way  INGRESS    <span class="m">1000</span>      tcp:22,tcp:6443,icmp        False

<span class="c1"># 設定したfirewall定義を確認する</span>
$ gcloud compute firewall-rules list --filter<span class="o">=</span><span class="s2">&#34;network:kubernetes-the-hard-way&#34;</span>
NAME                                    NETWORK                  DIRECTION  PRIORITY  ALLOW                 DENY  DISABLED
kubernetes-the-hard-way-allow-external  kubernetes-the-hard-way  INGRESS    <span class="m">1000</span>      tcp:22,tcp:6443,icmp        False
kubernetes-the-hard-way-allow-internal  kubernetes-the-hard-way  INGRESS    <span class="m">1000</span>      tcp,udp,icmp                False

To show all fields of the firewall, please show in JSON format: --format<span class="o">=</span>json
To show all fields in table format, please see the examples in --help.
</code></pre></td></tr></table>
</div>
</div><p>次に、Kubernetes API Serverの前段のexternal load balancerにIPアドレスを付与する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># IPアドレスを付与する</span>
$ gcloud compute addresses create kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt; --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span>
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/addresses/kubernetes-the-hard-way<span class="o">]</span>.

<span class="c1"># ちなみに --region に与えている値はシンプルなregion名</span>
$ gcloud config get-value compute/region
us-west1

<span class="c1"># 付与されたIPアドレスを確認する</span>
$ gcloud compute addresses list --filter<span class="o">=</span><span class="s2">&#34;name=(&#39;kubernetes-the-hard-way&#39;)&#34;</span>
NAME                     ADDRESS/RANGE  TYPE      PURPOSE  NETWORK  REGION    SUBNET  STATUS
kubernetes-the-hard-way  34.82.55.89    EXTERNAL                    us-west1          RESERVED
</code></pre></td></tr></table>
</div>
</div><p>ネットワークまわりが終わったので次はCompute Instance(サーバー)のプロビジョニング。
コントローラーノードは<code>controller-0</code>、<code>controller-1</code>、<code>controller-2</code>の3台。
ワーカーノードは<code>worker-0</code>、<code>worker-1</code>、<code>worker-2</code>の3台。
OSは<code>Ubuntu 18.04</code>。せっかくなので各オプションを調べてみた。</p>
<ul>
<li><code>--async</code><br>
インスタンスが生成される前にプロンプトが返ってくる。<br>
これがないとプロビジョニングが完了するまで待たされるのだろうか。</li>
<li><code>--boot-disk-size</code><br>
ブートディスクのサイズを指定する。<br>
今回は200GB指定。</li>
<li><code>--can-ip-forward</code><br>
IP転送を有効化する。<br>
インスタンス作成時にしか指定できない模様。</li>
<li><code>--image-family</code><br>
使用するイメージファミリーを指定する。
今回は<code>ubuntu-1804-lts</code>を使用する。</li>
<li><code>--image-project</code><br>
使用するイメージプロジェクトを指定する。<br>
今回は<code>ubuntu-os-cloud</code>を使用する。</li>
<li><code>--machine-type</code><br>
インスタンスのマシンタイプを指定する。<br>
マシンタイプのリストは<code>gcloud compute machine-types list</code>で確認できる。<br>
(が、数千行表示されるので絞ったほうが良い。)<br>
今回は<code>n1-standard-1</code>なので1vCPU、メモリは3.75GB。</li>
<li><code>--metadata</code><br>
インスタンスに付与するメタデータを<code>KEY = VALUE</code>の形で指定する。<br>
ワーカーノードにのみ<code>pod-cidr=10.200.${i}.0/24</code>を指定する。</li>
<li><code>--private-network-ip</code><br>
インスタンスに付与するプライベートIPアドレスを指定する。</li>
<li><code>--scopes</code><br>
インスタンスに設定するアクセススコープを指定する。<br>
一つひとつの意味はまた今度。。
今回指定するのは<code>compute-rw</code>,<code>storage-ro</code>,<code>service-management</code>,<code>service-control</code>,<code>logging-write</code>,<code>monitoring</code>の6つ。</li>
<li><code>--subnet</code><br>
文字通りサブネットを指定する。<br>
先ほど作成した<code>kubernetes</code>を指定する。</li>
<li><code>--tags</code><br>
タグを指定する。<br>
ここでは<code>kubernetes-the-hard-way</code>と<code>controller</code>または<code>worker</code>を指定する。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># コンピュートノードの作成</span>
$ <span class="k">for</span> i in <span class="m">0</span> <span class="m">1</span> 2<span class="p">;</span> <span class="k">do</span>
&gt; gcloud compute instances create controller-<span class="si">${</span><span class="nv">i</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --async <span class="se">\
</span><span class="se"></span>&gt;   --boot-disk-size 200GB <span class="se">\
</span><span class="se"></span>&gt;   --can-ip-forward <span class="se">\
</span><span class="se"></span>&gt;   --image-family ubuntu-1804-lts <span class="se">\
</span><span class="se"></span>&gt;   --image-project ubuntu-os-cloud <span class="se">\
</span><span class="se"></span>&gt;   --machine-type n1-standard-1 <span class="se">\
</span><span class="se"></span>&gt;   --private-network-ip 10.240.0.1<span class="si">${</span><span class="nv">i</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring <span class="se">\
</span><span class="se"></span>&gt;   --subnet kubernetes <span class="se">\
</span><span class="se"></span>&gt;   --tags kubernetes-the-hard-way,controller
&gt; <span class="k">done</span>
NOTE: The users will be charged <span class="k">for</span> public IPs when VMs are created.
Instance creation in progress <span class="k">for</span> <span class="o">[</span>controller-0<span class="o">]</span>: https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/operations/operation-1586090309937-5a28a6d81698c-5e87a931-f5d96fc2
Use <span class="o">[</span>gcloud compute operations describe URI<span class="o">]</span> <span class="nb">command</span> to check the status of the operation<span class="o">(</span>s<span class="o">)</span>.


Updates are available <span class="k">for</span> some Cloud SDK components.  To install them,
please run:
  $ gcloud components update

  NOTE: The users will be charged <span class="k">for</span> public IPs when VMs are created.
  Instance creation in progress <span class="k">for</span> <span class="o">[</span>controller-1<span class="o">]</span>: https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/operations/operation-1586090312861-5a28a6dae0855-5c8f5340-f16f0b0b
  Use <span class="o">[</span>gcloud compute operations describe URI<span class="o">]</span> <span class="nb">command</span> to check the status of the operation<span class="o">(</span>s<span class="o">)</span>.
  NOTE: The users will be charged <span class="k">for</span> public IPs when VMs are created.
  Instance creation in progress <span class="k">for</span> <span class="o">[</span>controller-2<span class="o">]</span>: https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/operations/operation-1586090315206-5a28a6dd1ce54-341cdef6-ab17401e
  Use <span class="o">[</span>gcloud compute operations describe URI<span class="o">]</span> <span class="nb">command</span> to check the status of the operation<span class="o">(</span>s<span class="o">)</span>.

<span class="c1"># ワーカーノードの作成</span>
$ <span class="k">for</span> i in <span class="m">0</span> <span class="m">1</span> 2<span class="p">;</span> <span class="k">do</span>
&gt; gcloud compute instances create worker-<span class="si">${</span><span class="nv">i</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --async <span class="se">\
</span><span class="se"></span>&gt;   --boot-disk-size 200GB <span class="se">\
</span><span class="se"></span>&gt;   --can-ip-forward <span class="se">\
</span><span class="se"></span>&gt;   --image-family ubuntu-1804-lts <span class="se">\
</span><span class="se"></span>&gt;   --image-project ubuntu-os-cloud <span class="se">\
</span><span class="se"></span>&gt;   --machine-type n1-standard-1 <span class="se">\
</span><span class="se"></span>&gt;   --metadata pod-cidr<span class="o">=</span>10.200.<span class="si">${</span><span class="nv">i</span><span class="si">}</span>.0/24 <span class="se">\
</span><span class="se"></span>&gt;   --private-network-ip 10.240.0.2<span class="si">${</span><span class="nv">i</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring <span class="se">\
</span><span class="se"></span>&gt;   --subnet kubernetes <span class="se">\
</span><span class="se"></span>&gt;   --tags kubernetes-the-hard-way,worker
&gt; <span class="k">done</span>
NOTE: The users will be charged <span class="k">for</span> public IPs when VMs are created.
Instance creation in progress <span class="k">for</span> <span class="o">[</span>worker-0<span class="o">]</span>: https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/operations/operation-1586091335171-5a28aaa9d3e0e-78d1704c-296260ad
Use <span class="o">[</span>gcloud compute operations describe URI<span class="o">]</span> <span class="nb">command</span> to check the status of the operation<span class="o">(</span>s<span class="o">)</span>.
NOTE: The users will be charged <span class="k">for</span> public IPs when VMs are created.
Instance creation in progress <span class="k">for</span> <span class="o">[</span>worker-1<span class="o">]</span>: https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/operations/operation-1586091337626-5a28aaac2b38a-79cf978c-bcb105b1
Use <span class="o">[</span>gcloud compute operations describe URI<span class="o">]</span> <span class="nb">command</span> to check the status of the operation<span class="o">(</span>s<span class="o">)</span>.
NOTE: The users will be charged <span class="k">for</span> public IPs when VMs are created.
Instance creation in progress <span class="k">for</span> <span class="o">[</span>worker-2<span class="o">]</span>: https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/operations/operation-1586091340120-5a28aaae8c0cc-024cf075-934bbdc9
Use <span class="o">[</span>gcloud compute operations describe URI<span class="o">]</span> <span class="nb">command</span> to check the status of the operation<span class="o">(</span>s<span class="o">)</span>.

<span class="c1"># 作成したインスタンスの確認</span>
$ gcloud compute instances list
NAME          ZONE        MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP     STATUS
controller-0  us-west1-c  n1-standard-1               10.240.0.10  34.83.154.108   RUNNING
controller-1  us-west1-c  n1-standard-1               10.240.0.11  34.82.53.165    RUNNING
controller-2  us-west1-c  n1-standard-1               10.240.0.12  34.82.94.111    RUNNING
worker-0      us-west1-c  n1-standard-1               10.240.0.20  35.233.216.214  RUNNING
worker-1      us-west1-c  n1-standard-1               10.240.0.21  35.197.40.89    RUNNING
worker-2      us-west1-c  n1-standard-1               10.240.0.22  34.82.6.170     RUNNING
</code></pre></td></tr></table>
</div>
</div><p>次に作成したインスタンスに対してSSH接続設定をしていく。<br>
<code>gcloud compute ssh &lt;インスタンス名&gt;</code>で簡単に公開鍵接続してくれるし、鍵は自動生成してローカルに保管してくれる。
GLBに振ったGIPとか全く意識しないでいいんだね。sshコマンドすら必要ないと。
きっとこれくらい当たり前なのだろうが、Cloudすごい。
そして改めて、この便利さがわかるくらいにはオンプレ経験積んでいてよかったと思った。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># controller-0インスタンスにSSH接続する</span>
$ gcloud compute ssh controller-0
WARNING: The public SSH key file <span class="k">for</span> gcloud does not exist.
WARNING: The private SSH key file <span class="k">for</span> gcloud does not exist.
WARNING: You <span class="k">do</span> not have an SSH key <span class="k">for</span> gcloud.
WARNING: SSH keygen will be executed to generate a key.
Generating public/private rsa key pair.
Enter passphrase <span class="o">(</span>empty <span class="k">for</span> no passphrase<span class="o">)</span>:
Enter same passphrase again:
Your identification has been saved in /Users/yuendo/.ssh/google_compute_engine.
Your public key has been saved in /Users/yuendo/.ssh/google_compute_engine.pub.
The key fingerprint is:
SHA256:AN/U3tVcjSPF6gHTu4RaztZYSfzNijSXENkntoJYrtg yuendo@yuendo.local
The key<span class="s1">&#39;s randomart image is:
</span><span class="s1">+---[RSA 2048]----+
</span><span class="s1">|    .   .. o.*.++|
</span><span class="s1">|     o o  = B O =|
</span><span class="s1">|      o .= B X O |
</span><span class="s1">|       .. * % = o|
</span><span class="s1">|       oS* B B . |
</span><span class="s1">|      . E = = .  |
</span><span class="s1">|         .       |
</span><span class="s1">|                 |
</span><span class="s1">|                 |
</span><span class="s1">+----[SHA256]-----+
</span><span class="s1">Updating project ssh metadata...⠛Updated [https://www.googleapis.com/compute/v1/projects/rising-capsule-272923].
</span><span class="s1">Updating project ssh metadata...done.
</span><span class="s1">Waiting for SSH key to propagate.
</span><span class="s1">Warning: Permanently added &#39;</span>compute.8343756058109702057<span class="s1">&#39; (ECDSA) to the list of known hosts.
</span><span class="s1">Enter passphrase for key &#39;</span>/Users/yuendo/.ssh/google_compute_engine<span class="s1">&#39;:
</span><span class="s1">bash: warning: setlocale: LC_ALL: cannot change locale (ja_JP.UTF-8)
</span><span class="s1">Enter passphrase for key &#39;</span>/Users/yuendo/.ssh/google_compute_engine<span class="s1">&#39;:
</span><span class="s1">Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 5.0.0-1033-gcp x86_64)
</span><span class="s1">
</span><span class="s1"> * Documentation:  https://help.ubuntu.com
</span><span class="s1"> * Management:     https://landscape.canonical.com
</span><span class="s1"> * Support:        https://ubuntu.com/advantage
</span><span class="s1">
</span><span class="s1">  System information as of Sun Apr  5 14:54:32 UTC 2020
</span><span class="s1">
</span><span class="s1">  System load:  0.15               Processes:           93
</span><span class="s1">  Usage of /:   0.6% of 193.66GB   Users logged in:     0
</span><span class="s1">  Memory usage: 6%                 IP address for ens4: 10.240.0.10
</span><span class="s1">  Swap usage:   0%
</span><span class="s1">
</span><span class="s1">
</span><span class="s1">0 packages can be updated.
</span><span class="s1">0 updates are security updates.
</span><span class="s1">
</span><span class="s1">
</span><span class="s1">-bash: warning: setlocale: LC_ALL: cannot change locale (ja_JP.UTF-8)
</span><span class="s1">yuendo@controller-0:~$
</span><span class="s1">yuendo@controller-0:~$ hostname
</span><span class="s1">controller-0
</span><span class="s1">yuendo@controller-0:~$ exit
</span><span class="s1">logout
</span><span class="s1">Connection to 34.83.154.108 closed.
</span><span class="s1">
</span><span class="s1"># 2台目以降は鍵生成がスキップされるのでパスフレーズ入力のみでOK
</span><span class="s1">$ gcloud compute ssh controller-1
</span><span class="s1">Warning: Permanently added &#39;</span>compute.1533735366172110758<span class="s1">&#39; (ECDSA) to the list of known hosts.
</span><span class="s1">Enter passphrase for key &#39;</span>/Users/yuendo/.ssh/google_compute_engine<span class="err">&#39;</span>:
Welcome to Ubuntu 18.04.4 LTS <span class="o">(</span>GNU/Linux 5.0.0-1033-gcp x86_64<span class="o">)</span>

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sun Apr  <span class="m">5</span> 14:56:57 UTC <span class="m">2020</span>

  System load:  0.0                Processes:           <span class="m">93</span>
  Usage of /:   0.6% of 193.66GB   Users logged in:     <span class="m">0</span>
  Memory usage: 6%                 IP address <span class="k">for</span> ens4: 10.240.0.11
  Swap usage:   0%

<span class="m">0</span> packages can be updated.
<span class="m">0</span> updates are security updates.



The programs included with the Ubuntu system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for</span> each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

-bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
yuendo@controller-1:~$ <span class="nb">exit</span>
<span class="nb">logout</span>
Connection to 34.82.53.165 closed.
</code></pre></td></tr></table>
</div>
</div><h4 id="provisioning-a-ca-and-generating-tls-certificates">Provisioning a CA and Generating TLS Certificates</h4>
<p><code>cfssl</code>を使用してPKIを構築し、TLS証明書を作成してetcdやkube-apiserver、kube-cntroller-manager、kube-scheduler、kubelet、kube-proxyで利用する。
簡単にKubernetesクラスタを使えてしまう環境だとこのあたりは意識しない部分なので触れるのは良い。</p>
<p>まずはTLS証明書を生成するためのCA(認証局)を作成する。
<code>cfssl</code>のお作法も押さえておきたいけどこれはまた別の機会に勉強することにする。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># CA作成用の定義ファイル(json)を作成する</span>
$ cat &gt; ca-config.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;signing&#34;: {
</span><span class="s">&gt;     &#34;default&#34;: {
</span><span class="s">&gt;       &#34;expiry&#34;: &#34;8760h&#34;
</span><span class="s">&gt;     },
</span><span class="s">&gt;     &#34;profiles&#34;: {
</span><span class="s">&gt;       &#34;kubernetes&#34;: {
</span><span class="s">&gt;         &#34;usages&#34;: [&#34;signing&#34;, &#34;key enchipherment&#34;, &#34;server auth&#34;, &#34;client auth&#34;],
</span><span class="s">&gt;         &#34;expiry&#34;: &#34;8760h&#34;
</span><span class="s">&gt;       }
</span><span class="s">&gt;     }
</span><span class="s">&gt;   }
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>
$ cat &gt; ca-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;Kubernetes&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;       &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;       &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;       &#34;O&#34;: &#34;Kubernetes&#34;,
</span><span class="s">&gt;       &#34;OU&#34;: &#34;CA&#34;,
</span><span class="s">&gt;       &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># CAを作成する</span>
$ cfssl gencert -initca ca-csr.json <span class="p">|</span> cfssljson -bare ca
2020/04/06 09:29:05 <span class="o">[</span>INFO<span class="o">]</span> generating a new CA key and certificate from CSR
2020/04/06 09:29:05 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/06 09:29:05 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/06 09:29:05 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/06 09:29:05 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/06 09:29:05 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">90850648606527922823166338036678114017361696245</span>
$ ls -l
total <span class="m">40</span>
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">206</span>  <span class="m">4</span>  <span class="m">6</span> 09:25 ca-config.json
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">211</span>  <span class="m">4</span>  <span class="m">6</span> 09:28 ca-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1675</span>  <span class="m">4</span>  <span class="m">6</span> 09:29 ca-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1005</span>  <span class="m">4</span>  <span class="m">6</span> 09:29 ca.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1318</span>  <span class="m">4</span>  <span class="m">6</span> 09:29 ca.pem
</code></pre></td></tr></table>
</div>
</div><p>次に、Kubernetes各コンポーネントのサーバーとクライアントが<code>admin</code>ユーザーで認証するための証明書、秘密鍵を生成する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 設定ファイルを作成</span>
$ cat &gt; admin-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;admin&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;       &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;       &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;       &#34;O&#34;: &#34;system:masters&#34;,
</span><span class="s">&gt;       &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
</span><span class="s">&gt;       &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># 証明書、秘密鍵の発行</span>
$ cfssl gencert <span class="se">\
</span><span class="se"></span>&gt;   -ca<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   -ca-key<span class="o">=</span>ca-key.pem <span class="se">\
</span><span class="se"></span>&gt;   -config<span class="o">=</span>ca-config.json <span class="se">\
</span><span class="se"></span>&gt;   -profile<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>&gt;   admin-csr.json <span class="p">|</span> cfssljson -bare admin
2020/04/06 10:07:19 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/06 10:07:19 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/06 10:07:19 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/06 10:07:19 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/06 10:07:19 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">576206824480732581773247993937555634229824941414</span>
2020/04/06 10:07:19 <span class="o">[</span>WARNING<span class="o">]</span> This certificate lacks a <span class="s2">&#34;hosts&#34;</span> field. This makes it unsuitable <span class="k">for</span>
websites. For more information see the Baseline Requirements <span class="k">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="o">(</span>https://cabforum.org<span class="o">)</span><span class="p">;</span>
specifically, section 10.2.3 <span class="o">(</span><span class="s2">&#34;Information Requirements&#34;</span><span class="o">)</span>.
</code></pre></td></tr></table>
</div>
</div><p>次に<code>Node Authorizer</code>のための証明書を準備していく。<br>
<code>Node Authorizer</code>とは各ノードの<code>kubelet</code>によるAPIリクエストの権限管理を行う仕組み。
<code>kubelet</code>が<code>Node Authorizer</code>を利用するためには<code>system:nodes</code>グループ、<code>system:node:&lt;nodeName&gt;</code>ユーザーとしての認証情報を使用する必要がある。
そこで各ワーカーノード用に<code>Node Authorizer</code>の要件を満たす証明書、秘密鍵を作成する。<br>
<a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">Using Node Authorization</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 各インスタンスの証明書と鍵を生成する</span>
$ <span class="k">for</span> instance in worker-0 worker-1 worker-2<span class="p">;</span> <span class="k">do</span>
&gt; cat &gt; <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;system:node:${instance}&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;       &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;       &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;       &#34;O&#34;: &#34;system:nodes&#34;,
</span><span class="s">&gt;       &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
</span><span class="s">&gt;       &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>
&gt;
&gt; <span class="nv">EXTERNAL_IP</span><span class="o">=</span><span class="k">$(</span>gcloud compute instances describe <span class="si">${</span><span class="nv">instance</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --format <span class="s1">&#39;value(networkInterfaces[0].accessConfigs[0].natIP)&#39;</span><span class="k">)</span>
&gt;
&gt; <span class="nv">INTERNAL_IP</span><span class="o">=</span><span class="k">$(</span>gcloud compute instances describe <span class="si">${</span><span class="nv">instance</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --format <span class="s1">&#39;value(networkInterfaces[0].networkIP)&#39;</span><span class="k">)</span>
&gt;
&gt; cfssl gencert <span class="se">\
</span><span class="se"></span>&gt;   -ca<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   -ca-key<span class="o">=</span>ca-key.pem <span class="se">\
</span><span class="se"></span>&gt;   -config<span class="o">=</span>ca-config.json <span class="se">\
</span><span class="se"></span>&gt;   -hostname<span class="o">=</span><span class="si">${</span><span class="nv">instance</span><span class="si">}</span>,<span class="si">${</span><span class="nv">EXTERNAL_IP</span><span class="si">}</span>,<span class="si">${</span><span class="nv">INTERNAL_IP</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   -profile<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>&gt;   <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>-csr.json <span class="p">|</span> cfssljson -bare <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>
&gt; <span class="k">done</span>
2020/04/06 11:11:03 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/06 11:11:03 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/06 11:11:03 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/06 11:11:03 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/06 11:11:03 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">134469149077526658345470200677432217117434688316</span>
2020/04/06 11:11:07 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/06 11:11:07 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/06 11:11:07 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/06 11:11:07 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/06 11:11:07 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">297527141395865841609923144133945907757973028198</span>
2020/04/06 11:11:13 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/06 11:11:13 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/06 11:11:13 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/06 11:11:14 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/06 11:11:14 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">716966613419584164132112207828162868778990920340</span>

<span class="c1"># 各ワーカーノード用の証明書と鍵が生成されたことを確認</span>
kubernetes-the-hard-way $ ls -l <span class="p">|</span> grep worker
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">244</span>  <span class="m">4</span>  <span class="m">6</span> 11:10 worker-0-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1679</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-0-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1119</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-0.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1493</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-0.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">244</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-1-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1679</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-1-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1119</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-1.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1493</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-1.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">244</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-2-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1679</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-2-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1119</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-2.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1493</span>  <span class="m">4</span>  <span class="m">6</span> 11:11 worker-2.pem
</code></pre></td></tr></table>
</div>
</div><p>次に<code>kube-controller-manager</code>用の証明書、秘密鍵を生成する。<br>
<code>kube-controller-manager</code>はKubernetesの各オブジェクト(<code>deployment</code>とか<code>replicaset</code>とか)を処理する
コントローラーを実行、管理するコンポーネント。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 設定ファイルを作成</span>
$ cat &gt; kube-controller-manager-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;       &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;       &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;       &#34;O&#34;: &#34;system:kube-controller-manager&#34;,
</span><span class="s">&gt;       &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
</span><span class="s">&gt;       &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># 証明書、秘密鍵を生成</span>
$ cfssl gencert <span class="se">\
</span><span class="se"></span>&gt;   -ca<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   -ca-key<span class="o">=</span>ca-key.pem <span class="se">\
</span><span class="se"></span>&gt;   -config<span class="o">=</span>ca-config.json <span class="se">\
</span><span class="se"></span>&gt;   -profile<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>&gt;   kube-controller-manager-csr.json <span class="p">|</span> cfssljson -bare kube-controller-manager
2020/04/06 11:46:52 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/06 11:46:52 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/06 11:46:52 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/06 11:46:53 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/06 11:46:53 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">679473232700076883406215029775467144226798499074</span>
2020/04/06 11:46:53 <span class="o">[</span>WARNING<span class="o">]</span> This certificate lacks a <span class="s2">&#34;hosts&#34;</span> field. This makes it unsuitable <span class="k">for</span>
websites. For more information see the Baseline Requirements <span class="k">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="o">(</span>https://cabforum.org<span class="o">)</span><span class="p">;</span>
specifically, section 10.2.3 <span class="o">(</span><span class="s2">&#34;Information Requirements&#34;</span><span class="o">)</span>.

<span class="c1"># 証明書、秘密鍵が生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep kube-controller
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">272</span>  <span class="m">4</span>  <span class="m">6</span> 11:45 kube-controller-manager-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1675</span>  <span class="m">4</span>  <span class="m">6</span> 11:46 kube-controller-manager-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1090</span>  <span class="m">4</span>  <span class="m">6</span> 11:46 kube-controller-manager.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1484</span>  <span class="m">4</span>  <span class="m">6</span> 11:46 kube-controller-manager.pem
</code></pre></td></tr></table>
</div>
</div><p>同様に<code>kube-proxy</code>用の証明書、秘密鍵を生成する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 設定ファイルを作成</span>
$ cat &gt; kube-proxy-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;     &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;     &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;     &#34;O&#34;: &#34;system:node-proxier&#34;,
</span><span class="s">&gt;     &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
</span><span class="s">&gt;     &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># 証明書、秘密鍵を生成</span>
$ cfssl gencert <span class="se">\
</span><span class="se"></span>&gt;   -ca<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   -ca-key<span class="o">=</span>ca-key.pem <span class="se">\
</span><span class="se"></span>&gt;   -config<span class="o">=</span>ca-config.json <span class="se">\
</span><span class="se"></span>&gt;   -profile<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>&gt;   kube-proxy-csr.json <span class="p">|</span> cfssljson -bare kube-proxy
2020/04/07 01:31:05 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/07 01:31:05 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/07 01:31:05 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/07 01:31:05 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/07 01:31:05 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">550943186018666134011503850417710768928030027256</span>
2020/04/07 01:31:05 <span class="o">[</span>WARNING<span class="o">]</span> This certificate lacks a <span class="s2">&#34;hosts&#34;</span> field. This makes it unsuitable <span class="k">for</span>
websites. For more information see the Baseline Requirements <span class="k">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="o">(</span>https://cabforum.org<span class="o">)</span><span class="p">;</span>
specifically, section 10.2.3 <span class="o">(</span><span class="s2">&#34;Information Requirements&#34;</span><span class="o">)</span>.

<span class="c1"># 証明書、秘密鍵が生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep kube-proxy
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">238</span>  <span class="m">4</span>  <span class="m">7</span> 01:29 kube-proxy-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1679</span>  <span class="m">4</span>  <span class="m">7</span> 01:31 kube-proxy-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1058</span>  <span class="m">4</span>  <span class="m">7</span> 01:31 kube-proxy.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1452</span>  <span class="m">4</span>  <span class="m">7</span> 01:31 kube-proxy.pem
</code></pre></td></tr></table>
</div>
</div><p><code>kube-scheduler</code>用の証明書、秘密鍵を生成する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 設定ファイルを作成</span>
$ cat &gt; kube-scheduler-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;system:kube-scheduler&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;     &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;     &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;     &#34;O&#34;: &#34;system:node-scheduler&#34;,
</span><span class="s">&gt;     &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
</span><span class="s">&gt;     &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># 証明書、秘密鍵を生成</span>
$ cfssl gencert <span class="se">\
</span><span class="se"></span>&gt;   -ca<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   -ca-key<span class="o">=</span>ca-key.pem <span class="se">\
</span><span class="se"></span>&gt;   -config<span class="o">=</span>ca-config.json <span class="se">\
</span><span class="se"></span>&gt;   -profile<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>&gt;   kube-scheduler-csr.json <span class="p">|</span> cfssljson -bare kube-scheduler
2020/04/07 10:09:37 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/07 10:09:37 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/07 10:09:37 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/07 10:09:37 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/07 10:09:37 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">427276001573792461057994812533294374760900916972</span>
2020/04/07 10:09:37 <span class="o">[</span>WARNING<span class="o">]</span> This certificate lacks a <span class="s2">&#34;hosts&#34;</span> field. This makes it unsuitable <span class="k">for</span>
websites. For more information see the Baseline Requirements <span class="k">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="o">(</span>https://cabforum.org<span class="o">)</span><span class="p">;</span>
specifically, section 10.2.3 <span class="o">(</span><span class="s2">&#34;Information Requirements&#34;</span><span class="o">)</span>.

<span class="c1"># 証明書、秘密鍵が生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep scheduler
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">244</span>  <span class="m">4</span>  <span class="m">7</span> 10:00 kube-scheduler-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1675</span>  <span class="m">4</span>  <span class="m">7</span> 10:09 kube-scheduler-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1066</span>  <span class="m">4</span>  <span class="m">7</span> 10:09 kube-scheduler.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1460</span>  <span class="m">4</span>  <span class="m">7</span> 10:09 kube-scheduler.pem
</code></pre></td></tr></table>
</div>
</div><p><code>kubernetes API server</code>用の証明書、秘密鍵を生成する。<br>
この証明書には<code>kubernetes-the-hard-way</code>のスタティックIPやホスト名を含める必要があるとのこと。
複数のホスト名、IPに対応した証明書を生成するため、なのだろう。
<code>gcloud</code>でのグローバルIP(スタティックIP)の確認方法も覚えておこう。<br>
<code>gcloud compute addresses describe &lt;NAME&gt; --region &lt;REGION&gt; --format 'value(address)'</code><br>
公式のチュートリアルとかもそうだけど、環境依存の値を手順に埋め込むための工夫をしている部分はだいたい便利で良く使うコマンドだから
一緒に覚えておいたほうがお得ですね。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># スタティックIPをホスト名を変数に格納する</span>
$ <span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="o">=</span><span class="k">$(</span>gcloud compute addresses describe kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span> <span class="se">\
</span><span class="se"></span>&gt;   --format <span class="s1">&#39;value(address)&#39;</span><span class="k">)</span>
$ <span class="nv">KUBERNETES_HOSTNAMES</span><span class="o">=</span>kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.svc.cluster.local

<span class="c1"># 設定ファイルを作成</span>
$ cat &gt; kubernetes-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;kubernetes&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;       &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;       &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;       &#34;O&#34;: &#34;Kubernetes&#34;,
</span><span class="s">&gt;       &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
</span><span class="s">&gt;       &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># 証明書、秘密鍵を生成</span>
$ cfssl gencert <span class="se">\
</span><span class="se"></span>&gt;   -ca<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   -ca-key<span class="o">=</span>ca-key.pem <span class="se">\
</span><span class="se"></span>&gt;   -config<span class="o">=</span>ca-config.json <span class="se">\
</span><span class="se"></span>&gt;   -hostname<span class="o">=</span>10.32.0.1,10.240.0.10,10.240.0.11,10.240.0.12,<span class="si">${</span><span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="si">}</span>,127.0.0.1,<span class="si">${</span><span class="nv">KUBERNETES_HOSTNAMES</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   -profile<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>&gt;   kubernetes-csr.json <span class="p">|</span> cfssljson -bare kubernetes
2020/04/07 10:42:47 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/07 10:42:47 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/07 10:42:47 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
<span class="o">}</span>2020/04/07 10:42:48 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/07 10:42:48 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">163729464487851440424458865766232739527232482865</span>

<span class="c1"># 証明書、秘密鍵が生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep kubernetes
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">232</span>  <span class="m">4</span>  <span class="m">7</span> 10:40 kubernetes-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1679</span>  <span class="m">4</span>  <span class="m">7</span> 10:42 kubernetes-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1289</span>  <span class="m">4</span>  <span class="m">7</span> 10:42 kubernetes.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1663</span>  <span class="m">4</span>  <span class="m">7</span> 10:42 kubernetes.pem
</code></pre></td></tr></table>
</div>
</div><p>Kubernetes Controller Managerがサービスアカウント用のアクセストークンを発行するときに使用する<code>service-account</code>用の証明書、秘密鍵を生成する。
キーペア生成多い。。。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 設定ファイルを作成</span>
$ cat &gt; service-account-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; {
</span><span class="s">&gt;   &#34;CN&#34;: &#34;service-accounts&#34;,
</span><span class="s">&gt;   &#34;key&#34;: {
</span><span class="s">&gt;     &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">&gt;     &#34;size&#34;: 2048
</span><span class="s">&gt;   },
</span><span class="s">&gt;   &#34;names&#34;: [
</span><span class="s">&gt;     {
</span><span class="s">&gt;     &#34;C&#34;: &#34;US&#34;,
</span><span class="s">&gt;     &#34;L&#34;: &#34;Portland&#34;,
</span><span class="s">&gt;     &#34;O&#34;: &#34;Kubernetes&#34;,
</span><span class="s">&gt;     &#34;OU&#34;: &#34;Kubernetes The Hard Way&#34;,
</span><span class="s">&gt;     &#34;ST&#34;: &#34;Oregon&#34;
</span><span class="s">&gt;     }
</span><span class="s">&gt;   ]
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># 証明書、秘密鍵を生成</span>
$ cfssl gencert <span class="se">\
</span><span class="se"></span>&gt;   -ca<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   -ca-key<span class="o">=</span>ca-key.pem <span class="se">\
</span><span class="se"></span>&gt;   -config<span class="o">=</span>ca-config.json <span class="se">\
</span><span class="se"></span>&gt;   -profile<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>&gt;   service-account-csr.json <span class="p">|</span> cfssljson -bare service-account
2020/04/07 11:28:28 <span class="o">[</span>INFO<span class="o">]</span> generate received request
2020/04/07 11:28:28 <span class="o">[</span>INFO<span class="o">]</span> received CSR
2020/04/07 11:28:28 <span class="o">[</span>INFO<span class="o">]</span> generating key: rsa-2048
2020/04/07 11:28:28 <span class="o">[</span>INFO<span class="o">]</span> encoded CSR
2020/04/07 11:28:28 <span class="o">[</span>INFO<span class="o">]</span> signed certificate with serial number <span class="m">352697530456854155326963395973297074225587270743</span>
2020/04/07 11:28:28 <span class="o">[</span>WARNING<span class="o">]</span> This certificate lacks a <span class="s2">&#34;hosts&#34;</span> field. This makes it unsuitable <span class="k">for</span>
websites. For more information see the Baseline Requirements <span class="k">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="o">(</span>https://cabforum.org<span class="o">)</span><span class="p">;</span>
specifically, section 10.2.3 <span class="o">(</span><span class="s2">&#34;Information Requirements&#34;</span><span class="o">)</span>.

<span class="c1"># 証明書、秘密鍵が生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep service-account
-rw-r--r--  <span class="m">1</span> yuendo  staff   <span class="m">228</span>  <span class="m">4</span>  <span class="m">7</span> 11:27 service-account-csr.json
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">1679</span>  <span class="m">4</span>  <span class="m">7</span> 11:28 service-account-key.pem
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1041</span>  <span class="m">4</span>  <span class="m">7</span> 11:28 service-account.csr
-rw-r--r--  <span class="m">1</span> yuendo  staff  <span class="m">1440</span>  <span class="m">4</span>  <span class="m">7</span> 11:28 service-account.pem
</code></pre></td></tr></table>
</div>
</div><p>最後に生成したキーペアを各ノードに配布する。
ワーカーノードには各インスタンス用のものを、コントローラーノードには他のもろもろを配置する。
コントローラーノードに配布した<code>kube-proxy</code>、<code>kube-controller-manager</code>、<code>kube-scheduler</code>、<code>kubelet</code>の証明書は
次項のクライアント認証設定ファイルを作成するタイミングで使用するとのこと。
<code>gcloud compute scp</code>でインスタンスにscpできる、と。sshが簡単だからscpももちろん簡単。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ワーカーノードに配布</span>
$ <span class="k">for</span> instance in worker-0 worker-1 worker-2<span class="p">;</span> <span class="k">do</span>
&gt; gcloud compute scp ca.pem <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>-key.pem <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>.pem <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>:~/
&gt; <span class="k">done</span>
Warning: Permanently added <span class="s1">&#39;compute.2597580481715530664&#39;</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
ca.pem                      100% <span class="m">1318</span>    13.0KB/s   00:00
worker-0-key.pem            100% <span class="m">1679</span>    16.3KB/s   00:00
worker-0.pem                100% <span class="m">1493</span>    14.8KB/s   00:00
Warning: Permanently added <span class="s1">&#39;compute.3623460109291908006&#39;</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
ca.pem                      100% <span class="m">1318</span>    13.8KB/s   00:00
worker-1-key.pem            100% <span class="m">1679</span>    17.4KB/s   00:00
worker-1.pem                100% <span class="m">1493</span>    15.0KB/s   00:00
Warning: Permanently added <span class="s1">&#39;compute.2239166723584715683&#39;</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
ca.pem                      100% <span class="m">1318</span>    13.5KB/s   00:00
worker-2-key.pem            100% <span class="m">1679</span>    16.9KB/s   00:00
worker-2.pem                100% <span class="m">1493</span>    15.1KB/s   00:00

<span class="c1"># コントローラーノードに配布</span>
$ <span class="k">for</span> instance in controller-0 controller-1 controller-2<span class="p">;</span> <span class="k">do</span>
&gt; gcloud compute scp ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem <span class="se">\
</span><span class="se"></span>&gt; service-account-key.pem service-account.pem <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>:~/
&gt; <span class="k">done</span>
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
ca.pem                      100% <span class="m">1318</span>    12.7KB/s   00:00
ca-key.pem                  100% <span class="m">1675</span>    16.9KB/s   00:00
kubernetes-key.pem          100% <span class="m">1679</span>    16.1KB/s   00:00
kubernetes.pem              100% <span class="m">1663</span>    16.8KB/s   00:00
service-account-key.pem     100% <span class="m">1679</span>    16.5KB/s   00:00
service-account.pem         100% <span class="m">1440</span>    14.5KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
ca.pem                      100% <span class="m">1318</span>    13.6KB/s   00:00
ca-key.pem                  100% <span class="m">1675</span>    15.5KB/s   00:00
kubernetes-key.pem          100% <span class="m">1679</span>    17.3KB/s   00:00
kubernetes.pem              100% <span class="m">1663</span>    17.2KB/s   00:00
service-account-key.pem     100% <span class="m">1679</span>    17.2KB/s   00:00
service-account.pem         100% <span class="m">1440</span>    14.4KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
ca.pem                      100% <span class="m">1318</span>    13.5KB/s   00:00
ca-key.pem                  100% <span class="m">1675</span>    17.6KB/s   00:00
kubernetes-key.pem          100% <span class="m">1679</span>    17.0KB/s   00:00
kubernetes.pem              100% <span class="m">1663</span>    17.5KB/s   00:00
service-account-key.pem     100% <span class="m">1679</span>    15.9KB/s   00:00
service-account.pem         100% <span class="m">1440</span>    15.2KB/s   00:00
</code></pre></td></tr></table>
</div>
</div><h4 id="generating-kubernetes-configuration-files-for-authentication">Generating Kubernetes Configuration FIles for Authentication</h4>
<p>kubeconfig(Kubernetesの接続設定ファイル)を<code>controller manager</code>、<code>kubelet</code>、<code>kube-proxy</code>、<code>scheduler</code>と<code>admin</code>ユーザーに対して生成する。
kubeconfigはKubernetesの各クライアントがKubernetes API Serverに接続するために必要とのこと。
kubeconfigで行う設定は主に<code>clusters</code>と<code>users</code>と<code>contexts</code>の3種類。
<code>clusters</code>には接続先クラスタの情報、<code>users</code>には認証情報、<code>contexts</code>にはclusterとuserのペアとnamespaceを定義する。
まずは、このあと各コンポーネント(クライアント)用に度々使用する<code>kubectl config</code>のオプションについて整理しておく。
kubeconfigファイルをコマンドで作っていくイメージなので、別に直接ファイルを編集しても構わないと思う。</p>
<ul>
<li><code>kubectl config set-cluster</code><br>
kubeconfigに<code>clusters</code>のエントリを登録する。</li>
<li><code>kubectl config set-credentials</code><br>
kubeconfigに<code>users</code>のエントリを登録する。<br>
ユーザーと捉えるとわかりにくいが、ここでは<code>kube-proxy</code>などのコンポーネント名を登録していく。
ノードを登録する場合はユーザー名を<code>system:node:&lt;nodeName&gt;</code>とする。
<a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">Using Node Authorization</a></li>
<li><code>kubectl config set-context</code><br>
kubeconfigに<code>contexts</code>のエントリを登録する。<br>
ここでは上の2コマンドで登録した<code>clusters</code>と<code>users</code>を指定する。</li>
<li><code>kubectl config use-context</code><br>
コンテキストを切り替える。<br>
<code>--kubeconfig</code>でkubeconfigを指定する。
このコマンドを実行することで生成したkubeconfigの<code>current-context</code>に指定したコンテキスト名が入る。
kubeconfファイルを生成する前に<code>kubernetes-the-hard-way</code>のスタティックIPを変数に格納する。(証明書生成のセクションでもやった)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># kubernetes-the-hard-wayのスタティックIPを変数に格納する</span>
$ <span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="o">=</span><span class="k">$(</span>gcloud compute addresses describe kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span> <span class="se">\
</span><span class="se"></span>&gt;   --format <span class="s1">&#39;value(address)&#39;</span><span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>kubelet</code>のkubeconfファイルを生成する。<br>
このとき使用するクライアントの証明書は各Kubeletノード名と一致している必要がある。
これによって<code>kubelet</code>が<code>Node Authorizer</code>で認証されるようになる。
Kubernetesクラスタにワーカーノードが追加される、と考えるとイメージしやすい。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 各ワーカーノード用にkubeletのkubeconfファイルを生成する</span>
$ <span class="k">for</span> instance in worker-0 worker-1 worker-2<span class="p">;</span> <span class="k">do</span>
&gt; kubectl config set-cluster kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --certificate-authority<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --server<span class="o">=</span>https://<span class="si">${</span><span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="si">}</span>:6443 <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span><span class="si">${</span><span class="nv">instance</span><span class="si">}</span>.kubeconfig
&gt;
&gt; kubectl config set-credentials system:node:<span class="si">${</span><span class="nv">instance</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --client-certificate<span class="o">=</span><span class="si">${</span><span class="nv">instance</span><span class="si">}</span>.pem <span class="se">\
</span><span class="se"></span>&gt;   --client-key<span class="o">=</span><span class="si">${</span><span class="nv">instance</span><span class="si">}</span>-key.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span><span class="si">${</span><span class="nv">instance</span><span class="si">}</span>.kubeconfig
&gt;
&gt; kubectl config set-context default <span class="se">\
</span><span class="se"></span>&gt;   --cluster<span class="o">=</span>kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --user<span class="o">=</span>system:node:<span class="si">${</span><span class="nv">instance</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span><span class="si">${</span><span class="nv">instance</span><span class="si">}</span>.kubeconfig
&gt;
&gt; kubectl config use-context default --kubeconfig<span class="o">=</span><span class="si">${</span><span class="nv">instance</span><span class="si">}</span>.kubeconfig
&gt; <span class="k">done</span>
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.
User <span class="s2">&#34;system:node:worker-0&#34;</span> set.
Context <span class="s2">&#34;default&#34;</span> created.
Switched to context <span class="s2">&#34;default&#34;</span>.
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.
User <span class="s2">&#34;system:node:worker-1&#34;</span> set.
Context <span class="s2">&#34;default&#34;</span> created.
Switched to context <span class="s2">&#34;default&#34;</span>.
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.
User <span class="s2">&#34;system:node:worker-2&#34;</span> set.
Context <span class="s2">&#34;default&#34;</span> created.
Switched to context <span class="s2">&#34;default&#34;</span>.

<span class="c1"># kubeconfigファイルが生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep worker-..kubeconfig
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">6385</span>  <span class="m">4</span>  <span class="m">7</span> 13:58 worker-0.kubeconfig
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">6385</span>  <span class="m">4</span>  <span class="m">7</span> 13:58 worker-1.kubeconfig
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">6385</span>  <span class="m">4</span>  <span class="m">7</span> 13:59 worker-2.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p><code>kube-proxy</code>のkubeconfファイルを生成する。<br>
ユーザー名は<code>system:kube-proxy</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># kube-proxyのkubeconfファイルを生成する</span>
kubernetes-the-hard-way $ kubectl config set-cluster kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --certificate-authority<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --server<span class="o">=</span>https://<span class="si">${</span><span class="nv">KUBERNETES_PUBLIC_ADDRESSES</span><span class="si">}</span>:6443 <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.
kubernetes-the-hard-way $ kubectl config set-credentials system:kube-proxy <span class="se">\
</span><span class="se"></span>&gt;   --client-certificate<span class="o">=</span>kube-proxy.pem <span class="se">\
</span><span class="se"></span>&gt;   --client-key<span class="o">=</span>kube-proxy-key.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig
User <span class="s2">&#34;system:kube-proxy&#34;</span> set.
kubernetes-the-hard-way $ kubectl config set-context default <span class="se">\
</span><span class="se"></span>&gt;   --cluster<span class="o">=</span>kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --user<span class="o">=</span>system:kube-proxy <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig
Context <span class="s2">&#34;default&#34;</span> created.
$ kubectl config use-context default --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig
Switched to context <span class="s2">&#34;default&#34;</span>.

<span class="c1"># kubeconfigファイルが生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep kube-proxy.kubeconfig
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">6312</span>  <span class="m">4</span>  <span class="m">7</span> 15:13 kube-proxy.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p><code>kube-controller-manager</code>のkubeconfファイルを生成する。<br>
ユーザー名は<code>system:kube-controller-manager</code>
serverで指定するIPアドレスが<code>127.0.0.1</code>になっているのは<code>kube-controller-manager</code>がコントローラーノード上で動くからですね。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># kube-controller-managerのkubeconfファイルを生成する</span>
$ kubectl config set-cluster kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --certificate-authority<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --server<span class="o">=</span>https://127.0.0.1:6443 <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.
$ kubectl config set-credentials system:kube-controller-manager <span class="se">\
</span><span class="se"></span>&gt;   --client-certificate<span class="o">=</span>kube-controller-manager.pem <span class="se">\
</span><span class="se"></span>&gt;   --client-key<span class="o">=</span>kube-controller-manager-key.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig
User <span class="s2">&#34;system:kube-controller-manager&#34;</span> set.
kubernetes-the-hard-way $ kubectl config set-context default <span class="se">\
</span><span class="se"></span>&gt;   --cluster<span class="o">=</span>kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --user<span class="o">=</span>system:kube-controller-manager <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig
Context <span class="s2">&#34;default&#34;</span> created.
$ kubectl config use-context default --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig
Switched to context <span class="s2">&#34;default&#34;</span>.

<span class="c1"># kubeconfigファイルが生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep kube-controller-manager.kubeconfig
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">6387</span>  <span class="m">4</span>  <span class="m">7</span> 16:11 kube-controller-manager.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p><code>kube-scheduler</code>のkubeconfファイルを生成する。<br>
ユーザー名は<code>system:kube-scheduler</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># kube-schedulerのkubeconfファイルを生成する</span>
$ kubectl config set-cluster kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --certificate-authority<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --server<span class="o">=</span>https://127.0.0.1:6443 <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.
$ kubectl config set-credentials system:kube-scheduler <span class="se">\
</span><span class="se"></span>&gt;   --client-certificate<span class="o">=</span>kube-scheduler.pem <span class="se">\
</span><span class="se"></span>&gt;   --client-key<span class="o">=</span>kube-scheduler-key.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig
User <span class="s2">&#34;system:kube-scheduler&#34;</span> set.
$ kubectl config set-context default <span class="se">\
</span><span class="se"></span>&gt;   --cluster<span class="o">=</span>kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --user<span class="o">=</span>system:kube-scheduler <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig
Context <span class="s2">&#34;default&#34;</span> created.
$ kubectl config use-context default --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig
Switched to context <span class="s2">&#34;default&#34;</span>.

<span class="c1"># kubeconfigファイルが生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep kube-scheduler.kubeconfig
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">6337</span>  <span class="m">4</span>  <span class="m">7</span> 16:46 kube-scheduler.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p>最後に<code>admin</code>ユーザーのkubeconfファイルを生成する。<br>
これまではKubernetesのコンポーネント用のkubeconfだったがこれはユーザー認証用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># adminユーザーのkubeconfファイルを生成する</span>
$ kubectl config set-cluster kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --certificate-authority<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --server<span class="o">=</span>https://127.0.0.1:6443 <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>admin.kubeconfig
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.
$ kubectl config set-credentials admin <span class="se">\
</span><span class="se"></span>&gt;   --client-certificate<span class="o">=</span>admin.pem <span class="se">\
</span><span class="se"></span>&gt;   --client-key<span class="o">=</span>admin-key.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>admin.kubeconfig
User <span class="s2">&#34;admin&#34;</span> set.
$ kubectl config set-context default <span class="se">\
</span><span class="se"></span>&gt;   --cluster<span class="o">=</span>kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --user<span class="o">=</span>admin <span class="se">\
</span><span class="se"></span>&gt;   --kubeconfig<span class="o">=</span>admin.kubeconfig
Context <span class="s2">&#34;default&#34;</span> created.
$ kubectl config use-context default --kubeconfig<span class="o">=</span>admin.kubeconfig
Switched to context <span class="s2">&#34;default&#34;</span>.

<span class="c1"># kubeconfigファイルが生成されたことを確認</span>
$ ls -l <span class="p">|</span> grep admin.kubeconfig
-rw-------  <span class="m">1</span> yuendo  staff  <span class="m">6265</span>  <span class="m">4</span>  <span class="m">7</span> 17:52 admin.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p>生成したkubeconfファイルを各ノードに配布する。
<code>kubelet</code>用、<code>kube-proxy</code>用kubeconfははワーカーノードに、
<code>kube-controller-manager</code>用、<code>kube-scheduler</code>用、<code>admin</code>ユーザー用のkubeconfはコントローラーノードに配布する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ワーカーノードにファイル配布</span>
$ <span class="k">for</span> instance in worker-0 worker-1 worker-2<span class="p">;</span> <span class="k">do</span>
&gt;   gcloud compute scp <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>.kubeconfig kube-proxy.kubeconfig <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>:~/
&gt; <span class="k">done</span>
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
worker-0.kubeconfig             100% <span class="m">6385</span>    63.6KB/s   00:00
kube-proxy.kubeconfig           100% <span class="m">6312</span>    55.7KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
worker-1.kubeconfig                  100% <span class="m">6385</span>    63.8KB/s   00:00
kube-proxy.kubeconfig                100% <span class="m">6312</span>    55.6KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
worker-2.kubeconfig                  100% <span class="m">6385</span>    64.4KB/s   00:00
kube-proxy.kubeconfig                100% <span class="m">6312</span>    64.5KB/s   00:00

<span class="c1"># コントローラーノードにファイル配布</span>
$ <span class="k">for</span> instance in controller-0 controller-1 controller-2<span class="p">;</span> <span class="k">do</span>
&gt;   gcloud compute scp admin.kubeconfig kube-controller-manager.kubeconfig kube-scheduler.kubeconfig <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>:~/
&gt; <span class="k">done</span>
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
admin.kubeconfig                     100% <span class="m">6265</span>    64.2KB/s   00:00
kube-controller-manager.kubeconfig   100% <span class="m">6387</span>    64.9KB/s   00:00
kube-scheduler.kubeconfig            100% <span class="m">6337</span>    65.0KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
admin.kubeconfig                     100% <span class="m">6265</span>    63.4KB/s   00:00
kube-controller-manager.kubeconfig   100% <span class="m">6387</span>    63.7KB/s   00:00
kube-scheduler.kubeconfig            100% <span class="m">6337</span>    58.2KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
admin.kubeconfig                     100% <span class="m">6265</span>    62.8KB/s   00:00
kube-controller-manager.kubeconfig   100% <span class="m">6387</span>    66.5KB/s   00:00
kube-scheduler.kubeconfig            100% <span class="m">6337</span>    66.1KB/s   00:00
</code></pre></td></tr></table>
</div>
</div><h4 id="generating-the-data-encryption-config-and-key">Generating the Data Encryption Config and Key</h4>
<p>続いてはKubernetesにおけるクラスタ関連の保存データの暗号化について。
このセクションではKubernetes Secretsを暗号化するための暗号鍵と暗号化設定を生成していく。</p>
<p>まずは暗号鍵をランダム文字列で作成する。<br>
使ったことなかったけど、ランダム文字列の生成は<code>/dev/urandom</code>を<code>base64</code>にかける方法がメジャーらしい。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nv">ENCRYPTION_KEY</span><span class="o">=</span><span class="k">$(</span>head -c <span class="m">32</span> /dev/urandom <span class="p">|</span> base64<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><p>次に設定ファイルを作成してコントローラーノードに配置したらこの章は終わり。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 設定ファイルを作成</span>
$ cat &gt; encryption-config.yaml <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; kind: EncryptionConfig
</span><span class="s">&gt; apiVersion: v1
</span><span class="s">&gt; resources:
</span><span class="s">&gt;   - resources:
</span><span class="s">&gt;     - secrets
</span><span class="s">&gt;   providers:
</span><span class="s">&gt;     - aescbc:
</span><span class="s">&gt;       keys:
</span><span class="s">&gt;         - name: key1
</span><span class="s">&gt;           secret: ${ENCRYPTION_KEYS}
</span><span class="s">&gt;         - identity: {}
</span><span class="s">&gt; EOF</span>
<span class="c1"># 作成した設定ファイルを各コントローラーノードに配布する</span>
$ <span class="k">for</span> instance in controller-0 controller-1 controller-2<span class="p">;</span> <span class="k">do</span>
&gt;   gcloud compute scp encryption-config.yaml <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>:~/
&gt; <span class="k">done</span>
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
encryption-config.yaml                                                                                                                          100%  <span class="m">180</span>     1.8KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
encryption-config.yaml                                                                                                                          100%  <span class="m">180</span>     1.9KB/s   00:00
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
encryption-config.yaml                                                                                                                          100%  <span class="m">180</span>     1.9KB/s   00:00
</code></pre></td></tr></table>
</div>
</div><h4 id="bootstrapping-the-etcd-cluster">Bootstrapping the etcd Cluster</h4>
<p>Kubernetesのコンポーネントはステートレスで、Kubernetesクラスタの情報は全て<code>etcd</code>に保管されている。</p>
<p>The Hard Wayではtmuxを使って複数のコントローラーノードに同時に同じコマンドを実行することをおすすめしている。
tmuxで複数Paneを開いて<code>prefix</code>からの<code>:set synchronize-panes on</code>で有効化、<code>:set synchronize-panes off</code>で無効化。
3台ともばらばらに実行しても問題ない内容だけどシンクロさせたほうが手間が単純に3分の1になるのでおすすめ。
以下のターミナルログは<code>controller-0</code>にsshログインして実行したものだが、<code>controller-1</code>、<code>controller-2</code>でも同じことを実行している。</p>
<p>最後に<code>etcdctl</code>コマンドでetcdクラスタのメンバーを表示して確認しているが、頭に付けている<code>ETCDCTL_API=3</code>はetcdctlのAPIバージョンを明示的に指定するために使用されている。
<code>etcdctl</code>にはv2とv3があり、コマンドの引数が異なるため明示的に環境変数で指定しているのだそう。
Kubernetesではv3を使用するのでここでは<code>ETCDCTL_API=3</code>としている。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># etcdをwgetしてtarを展開</span>
yuendo@controller-0:~$ wget -q --show-progress --https-only --timestamping <span class="se">\
</span><span class="se"></span>&gt; <span class="s2">&#34;https://github.com/etcd-io/etcd/releases/download/v3.4.0/etcd-v3.4.0-linux-amd64.tar.gz&#34;</span>
etcd-v3.4.0-linux-amd64.tar.gz               100%<span class="o">[============================================================================================</span>&gt;<span class="o">]</span>  16.45M  21.4MB/s    in 0.8s
yuendo@controller-0:~$ tar -xvf etcd-v3.4.0-linux-amd64.tar.gz
tar: Ignoring unknown extended header keyword <span class="s1">&#39;SCHILY.dev&#39;</span>
tar: Ignoring unknown extended header keyword <span class="s1">&#39;SCHILY.ino&#39;</span>
tar: Ignoring unknown extended header keyword <span class="s1">&#39;SCHILY.nlink&#39;</span>
etcd-v3.4.0-linux-amd64/
<span class="o">(</span>長いので中略<span class="o">)</span>
tar: Ignoring unknown extended header keyword <span class="s1">&#39;SCHILY.dev&#39;</span>
tar: Ignoring unknown extended header keyword <span class="s1">&#39;SCHILY.ino&#39;</span>
tar: Ignoring unknown extended header keyword <span class="s1">&#39;SCHILY.nlink&#39;</span>
etcd-v3.4.0-linux-amd64/Documentation/metrics/v3.2.1

<span class="c1"># etcdの実行モジュール群を/usr/local/binに移動</span>
yuendo@controller-0:~$ sudo mv etcd-v3.4.0-linux-amd64/etcd* /usr/local/bin/

<span class="c1"># etcd用のディレクトリを作成</span>
yuendo@controller-0:~$ sudo mkdir -p /etc/etcd /var/lib/etcd
yuendo@controller-0:~$ sudo cp ca.pem kubernetes-key.pem kubernetes.pem /etc/etcd/

<span class="c1"># 自サーバーのローカルIPとホスト名を取得</span>
yuendo@controller-0:~$ <span class="nv">INTERNAL_IP</span><span class="o">=</span><span class="k">$(</span>curl -s -H <span class="s2">&#34;Metadata-Flavor: Google&#34;</span> <span class="se">\
</span><span class="se"></span>&gt; http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip<span class="k">)</span>
yuendo@controller-0:~$ <span class="nv">ETCD_NAME</span><span class="o">=</span><span class="k">$(</span>hostname -s<span class="k">)</span>

<span class="c1"># etcdのsystemd設定ファイルを作成</span>
yuendo@controller-0:~$ cat <span class="s">&lt;&lt; EOF | sudo tee /etc/systemd/system/etcd.service
</span><span class="s">&gt; [Unit]
</span><span class="s">&gt; Description=etcd
</span><span class="s">&gt; Documentation=https://github.com/coreos
</span><span class="s">&gt;
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; Type=notify
</span><span class="s">&gt; ExecStart=/usr/local/bin/etcd \\
</span><span class="s">&gt;   --name ${ETCD_NAME} \\
</span><span class="s">&gt;   --cert-file=/etc/etcd/kubernetes.pem \\
</span><span class="s">&gt;   --key-file=/etc/etcd/kubernetes-key.pem \\
</span><span class="s">&gt;   --peer-cert-file=/etc/etcd/kubernetes.pem \\
</span><span class="s">&gt;   --peer-key-file=/etc/etcd/kubernetes-key.pem \\
</span><span class="s">&gt;   --trusted-ca-file=/etc/etcd/ca.pem \\
</span><span class="s">&gt;   --peer-trusted-ca-file=/etc/etcd/ca.pem \\
</span><span class="s">&gt;   --peer-client-cert-auth \\
</span><span class="s">&gt;   --client-cert-auth \\
</span><span class="s">&gt;   --initial-advertise-peer-urls https://${INTERNAL_IP}:2380 \\
</span><span class="s">&gt;   --listen-peer-urls https://${INTERNAL_IP}:2380 \\
</span><span class="s">&gt;   --listen-client-urls https://${INTERNAL_IP}:2379,https://127.0.0.1:2379 \\
</span><span class="s">&gt;   --advertise-client-urls https://${INTERNAL_IP}:2379 \\
</span><span class="s">&gt;   --initial-cluster-token etcd-cluster-0 \\
</span><span class="s">&gt;   --initial-cluster controller-0=https://10.240.0.10:2380,controller-1=https://10.240.0.11:2380,controller-2=https://10.240.0.12:2380 \\
</span><span class="s">&gt;   --initial-cluster-state new \\
</span><span class="s">&gt;   --data-dir=/var/lib/etcd
</span><span class="s">&gt; Restart=on-failure
</span><span class="s">&gt; RestartSec=5
</span><span class="s">&gt;
</span><span class="s">&gt; [Install]
</span><span class="s">&gt; WantedBy=multi-user.target
</span><span class="s">&gt; EOF</span>

<span class="c1"># systemdリロードしてetcd.serviceをenable &amp; start</span>
yuendo@controller-0:~$ sudo systemctl daemon-reload
yuendo@controller-0:~$ sudo systemctl <span class="nb">enable</span> etcd.service
Created symlink /etc/systemd/system/multi-user.target.wants/etcd.service → /etc/systemd/system/etcd.service.
yuendo@controller-0:~$ sudo systemctl start etcd
yuendo@controller-0:~$ sudo systemctl status etcd

● etcd.service - etcd
   Loaded: loaded <span class="o">(</span>/etc/systemd/system/etcd.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
   Active: active <span class="o">(</span>running<span class="o">)</span> since Sun 2020-04-12 16:08:29 UTC<span class="p">;</span> 15s ago
     Docs: https://github.com/coreos
 Main PID: <span class="m">29342</span> <span class="o">(</span>etcd<span class="o">)</span>
    Tasks: <span class="m">8</span> <span class="o">(</span>limit: 4394<span class="o">)</span>
   CGroup: /system.slice/etcd.service
           └─29342 /usr/local/bin/etcd --name controller-0 --cert-file<span class="o">=</span>/etc/etcd/kubernetes.pem --key-file<span class="o">=</span>/etc/etcd/kubernetes-key.pem --peer-cert-file<span class="o">=</span>/etc/etcd/kubernetes.pem

<span class="c1"># etcdクラスタのメンバーを確認</span>
yuendo@controller-0:~$ sudo <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl member list <span class="se">\
</span><span class="se"></span>&gt;   --endpoints<span class="o">=</span>https://127.0.0.1:2379 <span class="se">\
</span><span class="se"></span>&gt;   --cacert<span class="o">=</span>/etc/etcd/ca.pem <span class="se">\
</span><span class="se"></span>&gt;   --cert<span class="o">=</span>/etc/etcd/kubernetes.pem <span class="se">\
</span><span class="se"></span>&gt;   --key<span class="o">=</span>/etc/etcd/kubernetes-key.pem
3a57933972cb5131, started, controller-2, https://10.240.0.12:2380, https://10.240.0.12:2379, <span class="nb">false</span>
f98dc20bce6225a0, started, controller-0, https://10.240.0.10:2380, https://10.240.0.10:2379, <span class="nb">false</span>
ffed16798470cab5, started, controller-1, https://10.240.0.11:2380, https://10.240.0.11:2379, <span class="nb">false</span>
</code></pre></td></tr></table>
</div>
</div><p><code>etcd</code>について少し調べたことを書き残しておく。<br>
まず、etcdはクラスタ内でレプリケーションを実現している。
その実装にあたっては<code>Raft</code>という考え方が使われている。
各ノードに役割を持たせて<code>Leader</code>と<code>Follower</code>が存在する仕組みのようで、<code>Raft</code>の制約上etcdクラスタは最低3台必要になる。
以下の記事が大変わかりやすかった。<br>
<a href="https://qiita.com/ksato9700/items/9b44a95ce27ac23a94e1">etcd総選挙を眺めてみる</a><br>
<a href="https://www.techscore.com/blog/2019/03/28/raft-consensus-algorithm/">Raft - Kubernetes(etcd)のHA構成はなぜ3台以上？</a><br>
あとはetcdが使用するPortについて。
<code>--listen-client-urls</code>で指定されている<code>2379</code>がAPIアクセス用、<code>--listen-peer-urls</code>で指定されている<code>2380</code>がetcdクラスタのメンバー間の通信用のPortとして使われる。<br>
<code>etcd</code>だけで深く勉強できそうだけれど本題はここじゃないので今回は深入りしないでおく。</p>
<h4 id="bootstrapping-the-kubernetes-control-plane">Bootstrapping the Kubernetes Control Plane</h4>
<p>いよいよKubernetesのControl Planeを作っていく。<br>
ここも例によってコントローラーノード3台それぞれにログインして同時に同じコマンドを入力していく。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Kubernetes Controller用のバイナリ群をダウンロード</span>
$ wget -q --show-progress --https-only --timestamping <span class="se">\
</span><span class="se"></span>&gt; <span class="s2">&#34;https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/linux/amd64/kube-apiserver&#34;</span> <span class="se">\
</span><span class="se"></span>&gt; <span class="s2">&#34;https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/linux/amd64/kube-controller-manager&#34;</span> <span class="se">\
</span><span class="se"></span>&gt; <span class="s2">&#34;https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/linux/amd64/kube-scheduler&#34;</span> <span class="se">\
</span><span class="se"></span>&gt; <span class="s2">&#34;https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/linux/amd64/kubectl&#34;</span>
kube-apiserver    100%<span class="o">[===============================</span>&gt;<span class="o">]</span> 156.90M   140MB/s    in 1.1s
kube-controller-ma100%<span class="o">[===============================</span>&gt;<span class="o">]</span> 111.03M   221MB/s    in 0.5s
kube-scheduler    100%<span class="o">[===============================</span>&gt;<span class="o">]</span>  36.99M  95.5MB/s    in 0.4s
kubectl           100%<span class="o">[===============================</span>&gt;<span class="o">]</span>  40.99M   194MB/s    in 0.2s

<span class="c1"># バイナリに実行権限を与えて /usr/local/bin に配置</span>
$ chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl
$ sudo mv kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/

<span class="c1"># Kubernetes API Server用のキーペアや設定ファイルを /var/lib/kubernetes に配置</span>
$ sudo mkdir -p /var/lib/kubernetes/
$ sudo mv ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem <span class="se">\
</span><span class="se"></span>&gt; service-account-key.pem service-account.pem <span class="se">\
</span><span class="se"></span>&gt; encryption-config.yaml /var/lib/kubernetes/

<span class="c1"># コントローラーノードのIPアドレス(ローカルIP)を取得する</span>
<span class="c1"># 後続のsystemdのunitファイル内で advertise-address として指定</span>
$ <span class="nv">INTERNAL_IP</span><span class="o">=</span><span class="k">$(</span>curl -s -H <span class="s2">&#34;Metadata-Flavor: Google&#34;</span> <span class="se">\
</span><span class="se"></span>&gt; http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip<span class="k">)</span>

<span class="c1"># Kubernetes API Serverのsystemd unitファイルを作成</span>
$ cat <span class="s">&lt;&lt; EOF | sudo tee /etc/systemd/system/kube-apiserver.service
</span><span class="s">&gt; [Unit]
</span><span class="s">&gt; Description=Kubernetes API Server
</span><span class="s">&gt; Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s">&gt;
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; ExecStart=/usr/local/bin/kube-apiserver \\
</span><span class="s">&gt;   --advertise-address=${INTERNAL_IP} \\
</span><span class="s">&gt;   --allow-privileged=true \\
</span><span class="s">&gt;   --apiserver-count=3 \\
</span><span class="s">&gt;   --audit-log-maxage=30 \\
</span><span class="s">&gt;   --audit-log-maxbackup=3 \\
</span><span class="s">&gt;   --audit-log-maxsize=100 \\
</span><span class="s">&gt;   --audit-log-path=/var/log/audit.log \\
</span><span class="s">&gt;   --authorization-mode=Node,RBAC \\
</span><span class="s">&gt;   --bind-address=0.0.0.0 \\
</span><span class="s">&gt;   --client-ca-file=/var/lib/kubernetes/ca.pem \\
</span><span class="s">&gt;   --enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\
</span><span class="s">&gt;   --etcd-cafile=/var/lib/kubernetes/ca.pem \\
</span><span class="s">&gt;   --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\
</span><span class="s">&gt;   --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\
</span><span class="s">&gt;   --etcd-servers=https://10.240.0.10:2379,https://10.240.0.11:2379,https://10.240.0.12:2379 \\
</span><span class="s">&gt;   --event-ttl=1h \\
</span><span class="s">&gt;   --encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\
</span><span class="s">&gt;   --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\
</span><span class="s">&gt;   --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\
</span><span class="s">&gt;   --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\
</span><span class="s">&gt;   --kubelet-https=true \\
</span><span class="s">&gt;   --runtime-config=api/all \\
</span><span class="s">&gt;   --service-account-key-file=/var/lib/kubernetes/service-account.pem \\
</span><span class="s">&gt;   --service-cluster-ip-range=10.32.0.0/24 \\
</span><span class="s">&gt;   --service-node-port-range=30000-32767 \\
</span><span class="s">&gt;   --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\
</span><span class="s">&gt;   --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\
</span><span class="s">&gt;   --v=2
</span><span class="s">&gt; Restart=on-failure
</span><span class="s">&gt; RestartSec=5
</span><span class="s">&gt;
</span><span class="s">&gt; [Install]
</span><span class="s">&gt; WantedBy=multi-user.target
</span><span class="s">&gt; EOF</span>
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Kubernetes API Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/kubernetes/kubernetes

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/kube-apiserver <span class="se">\
</span><span class="se"></span>  --advertise-address<span class="o">=</span>10.240.0.10 <span class="se">\
</span><span class="se"></span>  --allow-privileged<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --apiserver-count<span class="o">=</span><span class="m">3</span> <span class="se">\
</span><span class="se"></span>  --audit-log-maxage<span class="o">=</span><span class="m">30</span> <span class="se">\
</span><span class="se"></span>  --audit-log-maxbackup<span class="o">=</span><span class="m">3</span> <span class="se">\
</span><span class="se"></span>  --audit-log-maxsize<span class="o">=</span><span class="m">100</span> <span class="se">\
</span><span class="se"></span>  --audit-log-path<span class="o">=</span>/var/log/audit.log <span class="se">\
</span><span class="se"></span>  --authorization-mode<span class="o">=</span>Node,RBAC <span class="se">\
</span><span class="se"></span>  --bind-address<span class="o">=</span>0.0.0.0 <span class="se">\
</span><span class="se"></span>  --client-ca-file<span class="o">=</span>/var/lib/kubernetes/ca.pem <span class="se">\
</span><span class="se"></span>  --enable-admission-plugins<span class="o">=</span>NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota <span class="se">\
</span><span class="se"></span>  --etcd-cafile<span class="o">=</span>/var/lib/kubernetes/ca.pem <span class="se">\
</span><span class="se"></span>  --etcd-certfile<span class="o">=</span>/var/lib/kubernetes/kubernetes.pem <span class="se">\
</span><span class="se"></span>  --etcd-keyfile<span class="o">=</span>/var/lib/kubernetes/kubernetes-key.pem <span class="se">\
</span><span class="se"></span>  --etcd-servers<span class="o">=</span>https://10.240.0.10:2379,https://10.240.0.11:2379,https://10.240.0.12:2379 <span class="se">\
</span><span class="se"></span>  --event-ttl<span class="o">=</span>1h <span class="se">\
</span><span class="se"></span>  --encryption-provider-config<span class="o">=</span>/var/lib/kubernetes/encryption-config.yaml <span class="se">\
</span><span class="se"></span>  --kubelet-certificate-authority<span class="o">=</span>/var/lib/kubernetes/ca.pem <span class="se">\
</span><span class="se"></span>  --kubelet-client-certificate<span class="o">=</span>/var/lib/kubernetes/kubernetes.pem <span class="se">\
</span><span class="se"></span>  --kubelet-client-key<span class="o">=</span>/var/lib/kubernetes/kubernetes-key.pem <span class="se">\
</span><span class="se"></span>  --kubelet-https<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --runtime-config<span class="o">=</span>api/all <span class="se">\
</span><span class="se"></span>  --service-account-key-file<span class="o">=</span>/var/lib/kubernetes/service-account.pem <span class="se">\
</span><span class="se"></span>  --service-cluster-ip-range<span class="o">=</span>10.32.0.0/24 <span class="se">\
</span><span class="se"></span>  --service-node-port-range<span class="o">=</span>30000-32767 <span class="se">\
</span><span class="se"></span>  --tls-cert-file<span class="o">=</span>/var/lib/kubernetes/kubernetes.pem <span class="se">\
</span><span class="se"></span>  --tls-private-key-file<span class="o">=</span>/var/lib/kubernetes/kubernetes-key.pem <span class="se">\
</span><span class="se"></span>  --v<span class="o">=</span><span class="m">2</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">5</span>

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></td></tr></table>
</div>
</div><p>次に kube-controller-managerの設定をしていく。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># kube-controller-managerのkubeconfigファイルを /var/lib/kubernetes/ に移動</span>
$ sudo mv kube-controller-manager.kubeconfig /var/lib/kubernetes/

<span class="c1"># kube-controller-manager のsystemd unitファイルを作成</span>
$ cat <span class="s">&lt;&lt; EOF | sudo tee /etc/systemd/system/kube-controller-manager.service
</span><span class="s">&gt; [Unit]
</span><span class="s">&gt; Description=Kubernetes Controller Manager
</span><span class="s">&gt; Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s">&gt;
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; ExecStart=/usr/local/bin/kube-controller-manager \\
</span><span class="s">&gt;   --address=0.0.0.0 \\
</span><span class="s">&gt;   --cluster-cidr=10.200.0.0/16 \\
</span><span class="s">&gt;   --cluster-name=kubernetes \\
</span><span class="s">&gt;   --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem \\
</span><span class="s">&gt;   --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem \\
</span><span class="s">&gt;   --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\
</span><span class="s">&gt;   --leader-elect=true \\
</span><span class="s">&gt;   --root-ca-file=/var/lib/kubernetes/ca.pem \\
</span><span class="s">&gt;   --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem \\
</span><span class="s">&gt;   --service-cluster-ip-range=10.32.0.0/24 \\
</span><span class="s">&gt;   --use-service-account-credentials=true \\
</span><span class="s">&gt;   --v=2
</span><span class="s">&gt; Restart=on-failure
</span><span class="s">&gt; RestartSec=5
</span><span class="s">&gt;
</span><span class="s">&gt; [Install]
</span><span class="s">&gt; WantedBy=multi-user.target
</span><span class="s">&gt; EOF</span>
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Kubernetes Controller Manager
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/kubernetes/kubernetes

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/kube-controller-manager <span class="se">\
</span><span class="se"></span>  --address<span class="o">=</span>0.0.0.0 <span class="se">\
</span><span class="se"></span>  --cluster-cidr<span class="o">=</span>10.200.0.0/16 <span class="se">\
</span><span class="se"></span>  --cluster-name<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>  --cluster-signing-cert-file<span class="o">=</span>/var/lib/kubernetes/ca.pem <span class="se">\
</span><span class="se"></span>  --cluster-signing-key-file<span class="o">=</span>/var/lib/kubernetes/ca-key.pem <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>/var/lib/kubernetes/kube-controller-manager.kubeconfig <span class="se">\
</span><span class="se"></span>  --leader-elect<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --root-ca-file<span class="o">=</span>/var/lib/kubernetes/ca.pem <span class="se">\
</span><span class="se"></span>  --service-account-private-key-file<span class="o">=</span>/var/lib/kubernetes/service-account-key.pem <span class="se">\
</span><span class="se"></span>  --service-cluster-ip-range<span class="o">=</span>10.32.0.0/24 <span class="se">\
</span><span class="se"></span>  --use-service-account-credentials<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --v<span class="o">=</span><span class="m">2</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">5</span>

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></td></tr></table>
</div>
</div><p>続いてkube-schedulerの設定。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># kube-schedulerのkubeconfファイルを /ver/lib/kubernetes/ に配置</span>
$ sudo mv kube-scheduler.kubeconfig /var/lib/kubernetes/

<span class="c1"># kube-schedulerの設定ファイルを作成</span>
$ cat <span class="s">&lt;&lt; EOF | sudo tee /etc/kubernetes/config/kube-scheduler.yaml
</span><span class="s">&gt; apiVersion: kubeschedulerConfiguration
</span><span class="s">&gt; clientConnection:
</span><span class="s">&gt;   kubeconfig: &#34;/var/lib/kubernetes/kube-scheduler.kubeconfig&#34;
</span><span class="s">&gt; leaderElection:
</span><span class="s">&gt;   leaderElect: true
</span><span class="s">&gt; EOF</span>
apiVersion: kubeschedulerConfiguration
clientConnection:
  kubeconfig: <span class="s2">&#34;/var/lib/kubernetes/kube-scheduler.kubeconfig&#34;</span>
leaderElection:
  leaderElect: <span class="nb">true</span>

<span class="c1"># kube-schedulerのsystemd unitファイルを作成</span>
$ cat <span class="s">&lt;&lt; EOF | sudo tee /etc/systemd/system/kube-scheduler.service
</span><span class="s">&gt; [Unit]
</span><span class="s">&gt; Description=Kubernetes Scheduler
</span><span class="s">&gt; Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s">&gt;
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; ExecStart=/usr/local/bin/kube-scheduler \\
</span><span class="s">&gt;   --config=/etc/kubernetes/config/kube-scheduler.yaml \\
</span><span class="s">&gt;   --v=2
</span><span class="s">&gt; Restart=on-failure
</span><span class="s">&gt; RestartSec=5
</span><span class="s">&gt;
</span><span class="s">&gt; [Install]
</span><span class="s">&gt; WantedBy=multi-user.target
</span><span class="s">&gt; EOF</span>
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Kubernetes Scheduler
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/kubernetes/kubernetes

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/kube-scheduler <span class="se">\
</span><span class="se"></span>  --config<span class="o">=</span>/etc/kubernetes/config/kube-scheduler.yaml <span class="se">\
</span><span class="se"></span>  --v<span class="o">=</span><span class="m">2</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">5</span>

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></td></tr></table>
</div>
</div><p>作成したunitファイルを使ってコントローラーノードのサービスを起動する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># systemd unitファイルのリロード、コントローラーサービスの有効化・起動</span>
$ sudo systemctl daemon-reload
$ sudo systemctl <span class="nb">enable</span> kube-apiserver kube-controller-manager kube-scheduler
Created symlink /etc/systemd/system/multi-user.target.wants/kube-apiserver.service → /etc/systemd/system/kube-apiserver.service.
Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /etc/systemd/system/kube-controller-manager.service.
Created symlink /etc/systemd/system/multi-user.target.wants/kube-scheduler.service → /etc/systemd/system/kube-scheduler.service.
$ sudo systemctl start kube-apiserver kube-controller-manager kube-scheduler
</code></pre></td></tr></table>
</div>
</div><p>サービスが起動したのでヘルスチェックしてみる。<br>
Google Network Load Balancerを経由したHTTPSエンドポイントに対するヘルスチェックはできないとのことで、
nginxを導入、設定して80番へのHTTPヘルスチェックをAPIサーバーの6443番にプロキシする仕組みを作っていく。<br>
完全に本筋からずれている感あるけれどHard Wayだから仕方ない。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># nginxをインストール</span>
$ sudo apt-get update
Hit:1 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic InRelease
Get:2 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates InRelease <span class="o">[</span>88.7 kB<span class="o">]</span>
Get:3 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-backports InRelease <span class="o">[</span>74.6 kB<span class="o">]</span>
Get:4 http://security.ubuntu.com/ubuntu bionic-security InRelease <span class="o">[</span>88.7 kB<span class="o">]</span>
Hit:5 http://archive.canonical.com/ubuntu bionic InRelease
Get:6 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages <span class="o">[</span><span class="m">692</span> kB<span class="o">]</span>
Get:7 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages <span class="o">[</span><span class="m">657</span> kB<span class="o">]</span>
Fetched <span class="m">1601</span> kB in 2s <span class="o">(</span><span class="m">1033</span> kB/s<span class="o">)</span>
Reading package lists... Done
$ sudo apt-get install -y nginx
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  grub-pc-bin libnuma1
Use <span class="s1">&#39;sudo apt autoremove&#39;</span> to remove them.
The following additional packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5 libwebp6 libxpm4 nginx-common nginx-core
Suggested packages:
  libgd-tools fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5 libwebp6 libxpm4 nginx nginx-common nginx-core
<span class="m">0</span> upgraded, <span class="m">18</span> newly installed, <span class="m">0</span> to remove and <span class="m">18</span> not upgraded.
Need to get <span class="m">2462</span> kB of archives.
After this operation, <span class="m">8210</span> kB of additional disk space will be used.
Get:1 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libjpeg-turbo8 amd64 1.5.2-0ubuntu5.18.04.3 <span class="o">[</span><span class="m">110</span> kB<span class="o">]</span>
Get:2 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 fonts-dejavu-core all 2.37-1 <span class="o">[</span><span class="m">1041</span> kB<span class="o">]</span>
Get:3 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 fontconfig-config all 2.12.6-0ubuntu2 <span class="o">[</span>55.8 kB<span class="o">]</span>
Get:4 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 libfontconfig1 amd64 2.12.6-0ubuntu2 <span class="o">[</span><span class="m">137</span> kB<span class="o">]</span>
Get:5 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 libjpeg8 amd64 8c-2ubuntu8 <span class="o">[</span><span class="m">2194</span> B<span class="o">]</span>
Get:6 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 libjbig0 amd64 2.1-3.1build1 <span class="o">[</span>26.7 kB<span class="o">]</span>
Get:7 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libtiff5 amd64 4.0.9-5ubuntu0.3 <span class="o">[</span><span class="m">153</span> kB<span class="o">]</span>
Get:8 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 libwebp6 amd64 0.6.1-2 <span class="o">[</span><span class="m">185</span> kB<span class="o">]</span>
Get:9 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 libxpm4 amd64 1:3.5.12-1 <span class="o">[</span>34.0 kB<span class="o">]</span>
Get:10 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libgd3 amd64 2.2.5-4ubuntu0.4 <span class="o">[</span><span class="m">119</span> kB<span class="o">]</span>
Get:11 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 nginx-common all 1.14.0-0ubuntu1.7 <span class="o">[</span>37.4 kB<span class="o">]</span>
Get:12 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libnginx-mod-http-geoip amd64 1.14.0-0ubuntu1.7 <span class="o">[</span>11.2 kB<span class="o">]</span>
Get:13 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libnginx-mod-http-image-filter amd64 1.14.0-0ubuntu1.7 <span class="o">[</span>14.6 kB<span class="o">]</span>
Get:14 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libnginx-mod-http-xslt-filter amd64 1.14.0-0ubuntu1.7 <span class="o">[</span>13.0 kB<span class="o">]</span>
Get:15 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libnginx-mod-mail amd64 1.14.0-0ubuntu1.7 <span class="o">[</span>41.8 kB<span class="o">]</span>
Get:16 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libnginx-mod-stream amd64 1.14.0-0ubuntu1.7 <span class="o">[</span>63.7 kB<span class="o">]</span>
Get:17 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 nginx-core amd64 1.14.0-0ubuntu1.7 <span class="o">[</span><span class="m">413</span> kB<span class="o">]</span>
Get:18 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates/main amd64 nginx all 1.14.0-0ubuntu1.7 <span class="o">[</span><span class="m">3596</span> B<span class="o">]</span>
Fetched <span class="m">2462</span> kB in 0s <span class="o">(</span>10.8 MB/s<span class="o">)</span>
Preconfiguring packages ...
Selecting previously unselected package libjpeg-turbo8:amd64.
<span class="o">(</span>Reading database ... <span class="m">90521</span> files and directories currently installed.<span class="o">)</span>
Preparing to unpack .../00-libjpeg-turbo8_1.5.2-0ubuntu5.18.04.3_amd64.deb ...
Unpacking libjpeg-turbo8:amd64 <span class="o">(</span>1.5.2-0ubuntu5.18.04.3<span class="o">)</span> ...
Selecting previously unselected package fonts-dejavu-core.
Preparing to unpack .../01-fonts-dejavu-core_2.37-1_all.deb ...
Unpacking fonts-dejavu-core <span class="o">(</span>2.37-1<span class="o">)</span> ...
Selecting previously unselected package fontconfig-config.
Preparing to unpack .../02-fontconfig-config_2.12.6-0ubuntu2_all.deb ...
Unpacking fontconfig-config <span class="o">(</span>2.12.6-0ubuntu2<span class="o">)</span> ...
Selecting previously unselected package libfontconfig1:amd64.
Preparing to unpack .../03-libfontconfig1_2.12.6-0ubuntu2_amd64.deb ...
Unpacking libfontconfig1:amd64 <span class="o">(</span>2.12.6-0ubuntu2<span class="o">)</span> ...
Selecting previously unselected package libjpeg8:amd64.
Preparing to unpack .../04-libjpeg8_8c-2ubuntu8_amd64.deb ...
Unpacking libjpeg8:amd64 <span class="o">(</span>8c-2ubuntu8<span class="o">)</span> ...
Selecting previously unselected package libjbig0:amd64.
Preparing to unpack .../05-libjbig0_2.1-3.1build1_amd64.deb ...
Unpacking libjbig0:amd64 <span class="o">(</span>2.1-3.1build1<span class="o">)</span> ...
Selecting previously unselected package libtiff5:amd64.
Preparing to unpack .../06-libtiff5_4.0.9-5ubuntu0.3_amd64.deb ...
Unpacking libtiff5:amd64 <span class="o">(</span>4.0.9-5ubuntu0.3<span class="o">)</span> ...
Selecting previously unselected package libwebp6:amd64.
Preparing to unpack .../07-libwebp6_0.6.1-2_amd64.deb ...
Unpacking libwebp6:amd64 <span class="o">(</span>0.6.1-2<span class="o">)</span> ...
Selecting previously unselected package libxpm4:amd64.
Preparing to unpack .../08-libxpm4_1%3a3.5.12-1_amd64.deb ...
Unpacking libxpm4:amd64 <span class="o">(</span>1:3.5.12-1<span class="o">)</span> ...
Selecting previously unselected package libgd3:amd64.
Preparing to unpack .../09-libgd3_2.2.5-4ubuntu0.4_amd64.deb ...
Unpacking libgd3:amd64 <span class="o">(</span>2.2.5-4ubuntu0.4<span class="o">)</span> ...
Selecting previously unselected package nginx-common.
Preparing to unpack .../10-nginx-common_1.14.0-0ubuntu1.7_all.deb ...
Unpacking nginx-common <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Selecting previously unselected package libnginx-mod-http-geoip.
Preparing to unpack .../11-libnginx-mod-http-geoip_1.14.0-0ubuntu1.7_amd64.deb ...
Unpacking libnginx-mod-http-geoip <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Selecting previously unselected package libnginx-mod-http-image-filter.
Preparing to unpack .../12-libnginx-mod-http-image-filter_1.14.0-0ubuntu1.7_amd64.deb ...
Unpacking libnginx-mod-http-image-filter <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Selecting previously unselected package libnginx-mod-http-xslt-filter.
Preparing to unpack .../13-libnginx-mod-http-xslt-filter_1.14.0-0ubuntu1.7_amd64.deb ...
Unpacking libnginx-mod-http-xslt-filter <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Selecting previously unselected package libnginx-mod-mail.
Preparing to unpack .../14-libnginx-mod-mail_1.14.0-0ubuntu1.7_amd64.deb ...
Unpacking libnginx-mod-mail <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Selecting previously unselected package libnginx-mod-stream.
Preparing to unpack .../15-libnginx-mod-stream_1.14.0-0ubuntu1.7_amd64.deb ...
Unpacking libnginx-mod-stream <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Selecting previously unselected package nginx-core.
Preparing to unpack .../16-nginx-core_1.14.0-0ubuntu1.7_amd64.deb ...
Unpacking nginx-core <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Selecting previously unselected package nginx.
Preparing to unpack .../17-nginx_1.14.0-0ubuntu1.7_all.deb ...
Unpacking nginx <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Setting up libjbig0:amd64 <span class="o">(</span>2.1-3.1build1<span class="o">)</span> ...
Setting up fonts-dejavu-core <span class="o">(</span>2.37-1<span class="o">)</span> ...
Setting up nginx-common <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service → /lib/systemd/system/nginx.service.
Setting up libjpeg-turbo8:amd64 <span class="o">(</span>1.5.2-0ubuntu5.18.04.3<span class="o">)</span> ...
Setting up libnginx-mod-mail <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Setting up libxpm4:amd64 <span class="o">(</span>1:3.5.12-1<span class="o">)</span> ...
Setting up libnginx-mod-http-xslt-filter <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Setting up libnginx-mod-http-geoip <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Setting up libwebp6:amd64 <span class="o">(</span>0.6.1-2<span class="o">)</span> ...
Setting up libjpeg8:amd64 <span class="o">(</span>8c-2ubuntu8<span class="o">)</span> ...
Setting up fontconfig-config <span class="o">(</span>2.12.6-0ubuntu2<span class="o">)</span> ...
Setting up libnginx-mod-stream <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Setting up libtiff5:amd64 <span class="o">(</span>4.0.9-5ubuntu0.3<span class="o">)</span> ...
Setting up libfontconfig1:amd64 <span class="o">(</span>2.12.6-0ubuntu2<span class="o">)</span> ...
Setting up libgd3:amd64 <span class="o">(</span>2.2.5-4ubuntu0.4<span class="o">)</span> ...
Setting up libnginx-mod-http-image-filter <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Setting up nginx-core <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Setting up nginx <span class="o">(</span>1.14.0-0ubuntu1.7<span class="o">)</span> ...
Processing triggers <span class="k">for</span> systemd <span class="o">(</span>237-3ubuntu10.39<span class="o">)</span> ...
Processing triggers <span class="k">for</span> man-db <span class="o">(</span>2.8.3-2ubuntu0.1<span class="o">)</span> ...
Processing triggers <span class="k">for</span> ufw <span class="o">(</span>0.36-0ubuntu0.18.04.1<span class="o">)</span> ...
Processing triggers <span class="k">for</span> ureadahead <span class="o">(</span>0.100.0-21<span class="o">)</span> ...
Processing triggers <span class="k">for</span> libc-bin <span class="o">(</span>2.27-3ubuntu1<span class="o">)</span> ...

<span class="c1"># 80番へのHTTPアクセスを https://127.0.0.1:6443/healthz にプロキシする設定ファイルを作成</span>
$ cat &gt; kubernetes.default.svc.cluster.local <span class="s">&lt;&lt; EOF
</span><span class="s">&gt; server {
</span><span class="s">&gt;   listen        80;
</span><span class="s">&gt;   server_name kubernetes.default.svc.cluster.local;
</span><span class="s">&gt;
</span><span class="s">&gt;   location .healthz {
</span><span class="s">&gt;     proxy_pass        https://127.0.0.1:6443/healthz;
</span><span class="s">&gt;     proxy_ssl_trusted_certificate /var/lib/kubernetes/ca.pem;
</span><span class="s">&gt;   }
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>

<span class="c1"># 設定ファイルを配置、slinkを作成してnginxを起動</span>
$ sudo mv kubernetes.default.svc.cluster.local <span class="se">\
</span><span class="se"></span>&gt; /etc/nginx/sites-available/kubernetes.default.svc.cluster.local
$ sudo ln -s /etc/nginx/sites-available/kubernetes.default.svc.cluster.local /etc/nginx/sites-enabled/
$ sudo systemctl restart nginx
$ sudo systemctl <span class="nb">enable</span> nginx
Synchronizing state of nginx.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install <span class="nb">enable</span> nginx

<span class="c1"># コントローラーサービスの正常性確認をしてみる</span>
$ kubectl get componentstatuses --kubeconfig admin.kubeconfig
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-2               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span><span class="o">}</span>
etcd-1               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span><span class="o">}</span>
etcd-0               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span><span class="o">}</span>

$ curl -H <span class="s2">&#34;Host: kubernetes.default.svc.cluster.local&#34;</span> -i http://127.0.0.1/healthz
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Date: Mon, <span class="m">20</span> Apr <span class="m">2020</span> 14:43:27 GMT
Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: <span class="m">2</span>
Connection: keep-alive
X-Content-Type-Options: nosniff

ok
</code></pre></td></tr></table>
</div>
</div><p>続いて、Kubernetes API Serverが各ワーカーノードのKubelet APIにアクセスするためのRBAC設定を行っていく。
Kubelet側では<code>--authorization-mode</code>を<code>webhook</code>にしている前提とのこと。認証方法は他にもいろいろある。
<a href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/#using-flags-for-your-authorization-module">Using Flags for Your Authorization Module</a></p>
<p>ここから先の手順はコントローラーノード1台で実行すればクラスタ全体で反映されるようなので、
<code>controller-0</code>にログインした前提で進めていく。</p>
<p>流れとしては、以下の2ステップ。</p>
<ol>
<li>Kubelet APIへのアクセス権を持つClusterRoleとして<code>system:kube-apiserver-to-kubelet</code>を作成する。</li>
<li><code>system:kube-apiserver-to-kubelet</code>と<code>kubernetes</code>ユーザーを紐付けるClusterRoleBindingを作成する。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># &#34;system:kube-apiserver-to-kubelet&#34; Roleを作成</span>
$ cat <span class="s">&lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
</span><span class="s">&gt; apiVersion: rbac.authorization.k8s.io/v1beta1
</span><span class="s">&gt; kind: ClusterRole
</span><span class="s">&gt; metadata:
</span><span class="s">&gt;   annotations:
</span><span class="s">&gt;     rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span><span class="s">&gt;   labels:
</span><span class="s">&gt;     kubernetes.io/bootstrapping: rbac-defaults
</span><span class="s">&gt;   name: system:kube-apiserver-to-kubelet
</span><span class="s">&gt; rules:
</span><span class="s">&gt;   - apiGroups:
</span><span class="s">&gt;       - &#34;&#34;
</span><span class="s">&gt;     resources:
</span><span class="s">&gt;       - nodes/proxy
</span><span class="s">&gt;       - nodes/stats
</span><span class="s">&gt;       - nodes/log
</span><span class="s">&gt;       - nodes/spec
</span><span class="s">&gt;       - nodes/metrics
</span><span class="s">&gt;     verbs:
</span><span class="s">&gt;       - &#34;*&#34;
</span><span class="s">&gt; EOF</span>
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created

<span class="c1"># &#34;system:kube-apiserver-to-kubelet&#34; Roleを &#34;kubernetes&#34; Userに紐付けるClusterRoleBindingの作成</span>
$ cat <span class="s">&lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
</span><span class="s">&gt; apiVersion: rbac.authorization.k8s.io/v1beta1
</span><span class="s">&gt; kind: ClusterRoleBinding
</span><span class="s">&gt; metadata:
</span><span class="s">&gt;   name: system:kube-apiserver
</span><span class="s">&gt;   namespace: &#34;&#34;
</span><span class="s">&gt; roleRef:
</span><span class="s">&gt;   apiGroup: rbac.authorization.k8s.io
</span><span class="s">&gt;   kind: ClusterRole
</span><span class="s">&gt;   name: system:kube-apiserver-to-kubelet
</span><span class="s">&gt; subjects:
</span><span class="s">&gt;   - apiGroup: rbac.authorization.k8s.io
</span><span class="s">&gt;     kind: User
</span><span class="s">&gt;     name: kubernetes
</span><span class="s">&gt; EOF</span>
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre></td></tr></table>
</div>
</div><p>最後にLoad Balancerを作成する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># パブリックIPアドレスを変数に格納</span>
$ <span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="o">=</span><span class="k">$(</span>gcloud compute addresses describe kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;     --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span> <span class="se">\
</span><span class="se"></span>&gt;     --format <span class="s1">&#39;value(address)&#39;</span><span class="k">)</span>

<span class="c1"># ヘルスチェックを作成</span>
$ gcloud compute http-health-checks create kubernetes <span class="se">\
</span><span class="se"></span>&gt;     --description <span class="s2">&#34;Kubernetes Health Check&#34;</span> <span class="se">\
</span><span class="se"></span>&gt;     --host <span class="s2">&#34;kubernetes.default.svc.cluster.local&#34;</span> <span class="se">\
</span><span class="se"></span>&gt;     --request-path <span class="s2">&#34;/healthz&#34;</span>
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/httpHealthChecks/kubernetes<span class="o">]</span>.
NAME        HOST                                  PORT  REQUEST_PATH
kubernetes  kubernetes.default.svc.cluster.local  <span class="m">80</span>    /healthz

Updates are available <span class="k">for</span> some Cloud SDK components.  To install them,
please run:
  $ gcloud components update

  To take a quick anonymous survey, run:
    $ gcloud survey

<span class="c1"># ファイアウォールのルールを作成</span>
$ gcloud compute firewall-rules create kubernetes-the-hard-way-allow-health-check <span class="se">\
</span><span class="se"></span>&gt;    --network kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;    --source-ranges 209.85.152.0/22,209.85.204.0/22,35.191.0.0/16 <span class="se">\
</span><span class="se"></span>&gt;    --allow tcp
Creating firewall...⠶Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-health-check<span class="o">]</span>.
Creating firewall...done.
NAME                                        NETWORK                  DIRECTION  PRIORITY  ALLOW  DENY  DISABLED
kubernetes-the-hard-way-allow-health-check  kubernetes-the-hard-way  INGRESS    <span class="m">1000</span>      tcp          False

<span class="c1"># ターゲットプールを作成</span>
$ gcloud compute target-pools create kubernetes-target-pool <span class="se">\
</span><span class="se"></span>&gt;    --http-health-check kubernetes
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/targetPools/kubernetes-target-pool<span class="o">]</span>.
NAME                    REGION    SESSION_AFFINITY  BACKUP  HEALTH_CHECKS
kubernetes-target-pool  us-west1  NONE                      kubernetes

<span class="c1"># ターゲットプールにインスタンスを追加</span>
$ gcloud compute target-pools add-instances kubernetes-target-pool <span class="se">\
</span><span class="se"></span>&gt;    --instances controller-0,controller-1,controller-2
Updated <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/targetPools/kubernetes-target-pool<span class="o">]</span>.

<span class="c1"># 転送ルールを作成</span>
$ gcloud compute forwarding-rules create kubernetes-forwarding-rule <span class="se">\
</span><span class="se"></span>&gt;    --address <span class="si">${</span><span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;    --ports <span class="m">6443</span> <span class="se">\
</span><span class="se"></span>&gt;    --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span> <span class="se">\
</span><span class="se"></span>&gt;    --target-pool kubernetes-target-pool&gt;     --target-pool kubernetes-target-pool
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/forwardingRules/kubernetes-forwarding-rule<span class="o">]</span>.
</code></pre></td></tr></table>
</div>
</div><p>作成したLoad Balancerが機能していることを確認する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># パブリックIPを変数に格納</span>
$ <span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="o">=</span><span class="k">$(</span>gcloud compute addresses describe kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;    --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span> <span class="se">\
</span><span class="se"></span>&gt;    --format <span class="s1">&#39;value(address)&#39;</span><span class="k">)</span>

<span class="c1"># バージョン確認</span>
$ curl --cacert ca.pem https://<span class="si">${</span><span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="si">}</span>:6443/version
<span class="o">{</span>
  <span class="s2">&#34;major&#34;</span>: <span class="s2">&#34;1&#34;</span>,
  <span class="s2">&#34;minor&#34;</span>: <span class="s2">&#34;15&#34;</span>,
  <span class="s2">&#34;gitVersion&#34;</span>: <span class="s2">&#34;v1.15.3&#34;</span>,
  <span class="s2">&#34;gitCommit&#34;</span>: <span class="s2">&#34;2d3c76f9091b6bec110a5e63777c332469e0cba2&#34;</span>,
  <span class="s2">&#34;gitTreeState&#34;</span>: <span class="s2">&#34;clean&#34;</span>,
  <span class="s2">&#34;buildDate&#34;</span>: <span class="s2">&#34;2019-08-19T11:05:50Z&#34;</span>,
  <span class="s2">&#34;goVersion&#34;</span>: <span class="s2">&#34;go1.12.9&#34;</span>,
  <span class="s2">&#34;compiler&#34;</span>: <span class="s2">&#34;gc&#34;</span>,
  <span class="s2">&#34;platform&#34;</span>: <span class="s2">&#34;linux/amd64&#34;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="bootstrapping-the-kubernetes-worker-plane">Bootstrapping the Kubernetes Worker Plane</h4>
<p>KubernetesのControl PlaneができたのでWorker Planeを作成する。<br>
Worker noteの3台に以下のコンポーネントをインストールする。<br>
<code>runc</code>, <code>container networking plugins</code>, <code>containerd</code>, <code>kubelet</code>, <code>kube-proxy</code></p>
<p>3台のWorker nodeにログインして同時に実行していく。</p>
<p>まずOSに必要なパッケージ群をインストールする。
<code>socat</code>をインストールすることで<code>kubectl port-forward</code>が使えるようになるとのこと。
使ったことないけど<code>socat</code>はプロキシ的な使い方ができるみたい。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 必要なパッケージをインストール</span>
yuendo@worker-0:~$ sudo apt-get update
Hit:1 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:3 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic-backports InRelease
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
Hit:5 http://archive.canonical.com/ubuntu bionic InRelease
Reading package lists... Done
yuendo@worker-0:~$ sudo apt-get -y install socat conntrack ipset
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  grub-pc-bin libnuma1
Use <span class="s1">&#39;sudo apt autoremove&#39;</span> to remove them.
The following additional packages will be installed:
  libipset3
The following NEW packages will be installed:
  conntrack ipset libipset3 socat
<span class="m">0</span> upgraded, <span class="m">4</span> newly installed, <span class="m">0</span> to remove and <span class="m">33</span> not upgraded.
Need to get <span class="m">450</span> kB of archives.
After this operation, <span class="m">1560</span> kB of additional disk space will be used.
Get:1 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 conntrack amd64 1:1.4.4+snapshot20161117-6ubuntu2 <span class="o">[</span>30.6 kB<span class="o">]</span>
Get:2 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 libipset3 amd64 6.34-1 <span class="o">[</span>43.9 kB<span class="o">]</span>
Get:3 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 ipset amd64 6.34-1 <span class="o">[</span>33.7 kB<span class="o">]</span>
Get:4 http://us-west1.gce.archive.ubuntu.com/ubuntu bionic/main amd64 socat amd64 1.7.3.2-2ubuntu2 <span class="o">[</span><span class="m">342</span> kB<span class="o">]</span>
Fetched <span class="m">450</span> kB in 0s <span class="o">(</span>23.6 MB/s<span class="o">)</span>
Selecting previously unselected package conntrack.
<span class="o">(</span>Reading database ... <span class="m">126189</span> files and directories currently installed.<span class="o">)</span>
Preparing to unpack .../conntrack_1%3a1.4.4+snapshot20161117-6ubuntu2_amd64.deb ...
Unpacking conntrack <span class="o">(</span>1:1.4.4+snapshot20161117-6ubuntu2<span class="o">)</span> ...
Selecting previously unselected package libipset3:amd64.
Preparing to unpack .../libipset3_6.34-1_amd64.deb ...
Unpacking libipset3:amd64 <span class="o">(</span>6.34-1<span class="o">)</span> ...
Selecting previously unselected package ipset.
Preparing to unpack .../ipset_6.34-1_amd64.deb ...
Unpacking ipset <span class="o">(</span>6.34-1<span class="o">)</span> ...
Selecting previously unselected package socat.
Preparing to unpack .../socat_1.7.3.2-2ubuntu2_amd64.deb ...
Unpacking socat <span class="o">(</span>1.7.3.2-2ubuntu2<span class="o">)</span> ...
Setting up conntrack <span class="o">(</span>1:1.4.4+snapshot20161117-6ubuntu2<span class="o">)</span> ...
Setting up socat <span class="o">(</span>1.7.3.2-2ubuntu2<span class="o">)</span> ...
Setting up libipset3:amd64 <span class="o">(</span>6.34-1<span class="o">)</span> ...
Setting up ipset <span class="o">(</span>6.34-1<span class="o">)</span> ...
Processing triggers <span class="k">for</span> libc-bin <span class="o">(</span>2.27-3ubuntu1<span class="o">)</span> ...
Processing triggers <span class="k">for</span> man-db <span class="o">(</span>2.8.3-2ubuntu0.1<span class="o">)</span> ...
</code></pre></td></tr></table>
</div>
</div><p>次にSwapを無効化する。<br>
Swapを有効化していると<code>kubelet</code>が正常に起動できないとのことらしい。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># swapを無効化</span>
yuendo@worker-0:~$ sudo swapon --show
yuendo@worker-0:~$ sudo swapoff -a
yuendo@worker-0:~$ sudo swapon --show
</code></pre></td></tr></table>
</div>
</div><p>Worker用のバイナリをダウンロードし、それぞれディレクトリを作成した上でインストールしていく。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Worker Plane用のバイナリ群をダウンロード</span>
yuendo@worker-0:~$ wget -q --show-progress --https-only --timestamping <span class="se">\
</span><span class="se"></span>&gt;   https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.15.0/crictl-v1.15.0-linux-amd64.tar.gz <span class="se">\
</span><span class="se"></span>&gt;   https://github.com/opencontainers/runc/releases/download/v1.0.0-rc8/runc.amd64 <span class="se">\
</span><span class="se"></span>&gt;   https://github.com/containernetworking/plugins/releases/download/v0.8.2/cni-plugins-linux-amd64-v0.8.2.tgz <span class="se">\
</span><span class="se"></span>&gt;   https://github.com/containerd/containerd/releases/download/v1.2.9/containerd-1.2.9.linux-amd64.tar.gz <span class="se">\
</span><span class="se"></span>&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/linux/amd64/kubectl <span class="se">\
</span><span class="se"></span>&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/linux/amd64/kube-proxy <span class="se">\
</span><span class="se"></span>&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.3/bin/linux/amd64/kubelet
crictl-v1.15.0-linux-amd64.tar.gz            100%<span class="o">[===========================</span>&gt;<span class="o">]</span>  11.50M  16.2MB/s    in 0.7s
runc.amd64                                   100%<span class="o">[===========================</span>&gt;<span class="o">]</span>   9.79M  15.7MB/s    in 0.6s
cni-plugins-linux-amd64-v0.8.2.tgz           100%<span class="o">[===========================</span>&gt;<span class="o">]</span>  34.96M  30.9MB/s    in 1.1s
containerd-1.2.9.linux-amd64.tar.gz          100%<span class="o">[===========================</span>&gt;<span class="o">]</span>  32.96M  30.3MB/s    in 1.1s
kubectl                                      100%<span class="o">[===========================</span>&gt;<span class="o">]</span>  40.99M   108MB/s    in 0.4s
kube-proxy                                   100%<span class="o">[===========================</span>&gt;<span class="o">]</span>  35.27M   145MB/s    in 0.2s
kubelet                                      100%<span class="o">[===========================</span>&gt;<span class="o">]</span> 114.10M   220MB/s    in 0.5s

<span class="c1"># ダウンロードしたバイナリ群をインストール</span>
yuendo@worker-0:~$ sudo mkdir -p <span class="se">\
</span><span class="se"></span>&gt;   /etc/cni/net.d <span class="se">\
</span><span class="se"></span>&gt;   /opt/cni/bin <span class="se">\
</span><span class="se"></span>&gt;   /var/lib/kubelet <span class="se">\
</span><span class="se"></span>&gt;   /var/lib/kube-proxy <span class="se">\
</span><span class="se"></span>&gt;   /var/lib/kubernetes <span class="se">\
</span><span class="se"></span>&gt;   /var/run/kubernetes
yuendo@worker-0:~$ mkdir containerd
yuendo@worker-0:~$ tar -xvf crictl-v1.15.0-linux-amd64.tar.gz
crictl
yuendo@worker-0:~$ tar -xvf containerd-1.2.9.linux-amd64.tar.gz -C containerd
bin/
bin/containerd-shim-runc-v1
bin/ctr
bin/containerd
bin/containerd-stress
bin/containerd-shim
yuendo@worker-0:~$ sudo tar -xvf cni-plugins-linux-amd64-v0.8.2.tgz -C /opt/cni/bin/
./
./flannel
./ptp
./host-local
./firewall
./portmap
./tuning
./vlan
./host-device
./bandwidth
./sbr
./static
./dhcp
./ipvlan
./macvlan
./loopback
./bridge
yuendo@worker-0:~$ sudo mv runc.amd64 runc
yuendo@worker-0:~$ chmod +x crictl kubectl kube-proxy kubelet runc
yuendo@worker-0:~$ sudo mv crictl kubectl kube-proxy kubelet runc /usr/local/bin/
yuendo@worker-0:~$ sudo mv containerd/bin/* /bin/
</code></pre></td></tr></table>
</div>
</div><p>次にCNIネットワークの設定を行う。<br>
CNIとは<code>Container Network Interface</code>のこと。
「Linuxコンテナが作成された際のネットワーク接続性の確保とコンテナが削除された際のリソース開放を行う」とのこと。
bridgeを作ったりと、OpenStackとかとおんなじようなイメージですかね。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 各ノードのIPアドレスを変数に格納</span>
yuendo@worker-0:~$ <span class="nv">POD_CIDR</span><span class="o">=</span><span class="k">$(</span>curl -s -H <span class="s2">&#34;Metadata-Flavor: Google&#34;</span> <span class="se">\
</span><span class="se"></span>&gt;   http://metadata.google.internal/computeMetadata/v1/instance/attributes/pod-cidr<span class="k">)</span>

<span class="c1"># bridgeの設定ファイルを作成</span>
yuendo@worker-0:~$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/cni/net.d/10-bridge.conf
</span><span class="s">&gt; {
</span><span class="s">&gt;     &#34;cniVersion&#34;: &#34;0.3.1&#34;,
</span><span class="s">&gt;     &#34;name&#34;: &#34;bridge&#34;,
</span><span class="s">&gt;     &#34;type&#34;: &#34;bridge&#34;,
</span><span class="s">&gt;     &#34;bridge&#34;: &#34;cnio0&#34;,
</span><span class="s">&gt;     &#34;isGateway&#34;: true,
</span><span class="s">&gt;     &#34;ipMasq&#34;: true,
</span><span class="s">&gt;     &#34;ipam&#34;: {
</span><span class="s">&gt;         &#34;type&#34;: &#34;host-local&#34;,
</span><span class="s">&gt;         &#34;ranges&#34;: [
</span><span class="s">&gt;           [{&#34;subnet&#34;: &#34;${POD_CIDR}&#34;}]
</span><span class="s">&gt;         ],
</span><span class="s">&gt;         &#34;routes&#34;: [{&#34;dst&#34;: &#34;0.0.0.0/0&#34;}]
</span><span class="s">&gt;     }
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>
<span class="o">{</span>
     <span class="s2">&#34;cniVersion&#34;</span>: <span class="s2">&#34;0.3.1&#34;</span>,
     <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;bridge&#34;</span>,
     <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;bridge&#34;</span>,
     <span class="s2">&#34;bridge&#34;</span>: <span class="s2">&#34;cnio0&#34;</span>,
     <span class="s2">&#34;isGateway&#34;</span>: true,
     <span class="s2">&#34;ipMasq&#34;</span>: true,
     <span class="s2">&#34;ipam&#34;</span>: <span class="o">{</span>
         <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;host-local&#34;</span>,
         <span class="s2">&#34;ranges&#34;</span>: <span class="o">[</span>
           <span class="o">[{</span><span class="s2">&#34;subnet&#34;</span>: <span class="s2">&#34;10.200.0.0/24&#34;</span><span class="o">}]</span>
         <span class="o">]</span>,
         <span class="s2">&#34;routes&#34;</span>: <span class="o">[{</span><span class="s2">&#34;dst&#34;</span>: <span class="s2">&#34;0.0.0.0/0&#34;</span><span class="o">}]</span>
     <span class="o">}</span>
<span class="o">}</span>

<span class="c1"># loopbackの設定ファイルも作成</span>
yuendo@worker-0:~$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/cni/net.d/99-loopback.conf
</span><span class="s">&gt; {
</span><span class="s">&gt;     &#34;cniVersion&#34;: &#34;0.3.1&#34;,
</span><span class="s">&gt;     &#34;name&#34;: &#34;lo&#34;,
</span><span class="s">&gt;     &#34;type&#34;: &#34;loopback&#34;
</span><span class="s">&gt; }
</span><span class="s">&gt; EOF</span>
<span class="o">{</span>
    <span class="s2">&#34;cniVersion&#34;</span>: <span class="s2">&#34;0.3.1&#34;</span>,
    <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;lo&#34;</span>,
    <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;loopback&#34;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>続いてContainerdの設定をしていく。<br>
Containerdはコンテナランタイムで、Dockerから派生したOSS。
Dockerの内部でも利用されていて、実質コンテナの標準ランタイム。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># containerdの設定ファイル、systemd unitファイルを作成</span>
yuendo@worker-0:~$ sudo mkdir -p /etc/containerd/
yuendo@worker-0:~$ cat <span class="s">&lt;&lt; EOF | sudo tee /etc/containerd/config.toml
</span><span class="s">&gt; [plugins]
</span><span class="s">&gt;   [plugins.cri.containerd]
</span><span class="s">&gt;     snapshotter = &#34;overlayfs&#34;
</span><span class="s">&gt;     [plugins.cri.containerd.default_runtime]
</span><span class="s">&gt;       runtime_type = &#34;io.containerd.runtime.v1.linux&#34;
</span><span class="s">&gt;       runtime_engine = &#34;/usr/local/bin/runc&#34;
</span><span class="s">&gt;       runtime_root = &#34;&#34;
</span><span class="s">&gt; EOF</span>
<span class="o">[</span>plugins<span class="o">]</span>
  <span class="o">[</span>plugins.cri.containerd<span class="o">]</span>
    <span class="nv">snapshotter</span> <span class="o">=</span> <span class="s2">&#34;overlayfs&#34;</span>
    <span class="o">[</span>plugins.cri.containerd.default_runtime<span class="o">]</span>
      <span class="nv">runtime_type</span> <span class="o">=</span> <span class="s2">&#34;io.containerd.runtime.v1.linux&#34;</span>
      <span class="nv">runtime_engine</span> <span class="o">=</span> <span class="s2">&#34;/usr/local/bin/runc&#34;</span>
      <span class="nv">runtime_root</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>

yuendo@worker-0:~$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/containerd.service
</span><span class="s">&gt; [Unit]
</span><span class="s">&gt; Description=containerd container runtime
</span><span class="s">&gt; Documentation=https://containerd.io
</span><span class="s">&gt; After=network.target
</span><span class="s">&gt;
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; ExecStartPre=/sbin/modprobe overlay
</span><span class="s">&gt; ExecStart=/bin/containerd
</span><span class="s">&gt; Restart=always
</span><span class="s">&gt; RestartSec=5
</span><span class="s">&gt; Delegate=yes
</span><span class="s">&gt; KillMode=process
</span><span class="s">&gt; OOMScoreAdjust=-999
</span><span class="s">&gt; LimitNOFILE=1048576
</span><span class="s">&gt; LimitNPROC=infinity
</span><span class="s">&gt; LimitCORE=infinity
</span><span class="s">&gt;
</span><span class="s">&gt; [Install]
</span><span class="s">&gt; WantedBy=multi-user.target
</span><span class="s">&gt; EOF</span>
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>containerd container runtime
<span class="nv">Documentation</span><span class="o">=</span>https://containerd.io
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStartPre</span><span class="o">=</span>/sbin/modprobe overlay
<span class="nv">ExecStart</span><span class="o">=</span>/bin/containerd
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">5</span>
<span class="nv">Delegate</span><span class="o">=</span>yes
<span class="nv">KillMode</span><span class="o">=</span>process
<span class="nv">OOMScoreAdjust</span><span class="o">=</span>-999
<span class="nv">LimitNOFILE</span><span class="o">=</span><span class="m">1048576</span>
<span class="nv">LimitNPROC</span><span class="o">=</span>infinity
<span class="nv">LimitCORE</span><span class="o">=</span>infinity

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></td></tr></table>
</div>
</div><p>Kubeletも同様に設定ファイルを作成していく。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># キーペア、kubeconfigファイルをディレクトリに配置</span>
yuendo@worker-0:~$ sudo mv <span class="si">${</span><span class="nv">HOSTNAME</span><span class="si">}</span>-key.pem <span class="si">${</span><span class="nv">HOSTNAME</span><span class="si">}</span>.pem /var/lib/kubelet/
yuendo@worker-0:~$ sudo mv <span class="si">${</span><span class="nv">HOSTNAME</span><span class="si">}</span>.kubeconfig /var/lib/kubelet/kubeconfig
yuendo@worker-0:~$ sudo mv ca.pem /var/lib/kubernetes/

<span class="c1"># kubeletのconfigファイルを作成</span>
yuendo@worker-0:~$ cat <span class="s">&lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml
</span><span class="s">&gt; kind: KubeletConfiguration
</span><span class="s">&gt; apiVersion: kubelet.config.k8s.io/v1beta1
</span><span class="s">&gt; authentication:
</span><span class="s">&gt;   anonymous:
</span><span class="s">&gt;     enabled: false
</span><span class="s">&gt;   webhook:
</span><span class="s">&gt;     enabled: true
</span><span class="s">&gt;   x509:
</span><span class="s">&gt;     clientCAFile: &#34;/var/lib/kubernetes/ca.pem&#34;
</span><span class="s">&gt; authorization:
</span><span class="s">&gt;   mode: Webhook
</span><span class="s">&gt; clusterDomain: &#34;cluster.local&#34;
</span><span class="s">&gt; clusterDNS:
</span><span class="s">&gt;   - &#34;10.32.0.10&#34;
</span><span class="s">&gt; podCIDR: &#34;${POD_CIDR}&#34;
</span><span class="s">&gt; resolvConf: &#34;/run/systemd/resolve/resolv.conf&#34;
</span><span class="s">&gt; runtimeRequestTimeout: &#34;15m&#34;
</span><span class="s">&gt; tlsCertFile: &#34;/var/lib/kubelet/${HOSTNAME}.pem&#34;
</span><span class="s">&gt; tlsPrivateKeyFile: &#34;/var/lib/kubelet/${HOSTNAME}-key.pem&#34;
</span><span class="s">&gt; EOF</span>
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: <span class="nb">false</span>
  webhook:
    enabled: <span class="nb">true</span>
  x509:
    clientCAFile: <span class="s2">&#34;/var/lib/kubernetes/ca.pem&#34;</span>
authorization:
  mode: Webhook
clusterDomain: <span class="s2">&#34;cluster.local&#34;</span>
clusterDNS:
  - <span class="s2">&#34;10.32.0.10&#34;</span>
podCIDR: <span class="s2">&#34;10.200.0.0/24&#34;</span>
resolvConf: <span class="s2">&#34;/run/systemd/resolve/resolv.conf&#34;</span>
runtimeRequestTimeout: <span class="s2">&#34;15m&#34;</span>
tlsCertFile: <span class="s2">&#34;/var/lib/kubelet/worker-0.pem&#34;</span>
tlsPrivateKeyFile: <span class="s2">&#34;/var/lib/kubelet/worker-0-key.pem&#34;</span>
yuendo@worker-0:~$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service
</span><span class="s">&gt; [Unit]
</span><span class="s">&gt; Description=Kubernetes Kubelet
</span><span class="s">&gt; Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s">&gt; After=containerd.service
</span><span class="s">&gt; Requires=containerd.service
</span><span class="s">&gt;
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; ExecStart=/usr/local/bin/kubelet \\
</span><span class="s">&gt;   --config=/var/lib/kubelet/kubelet-config.yaml \\
</span><span class="s">&gt;   --container-runtime=remote \\
</span><span class="s">&gt;   --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\
</span><span class="s">&gt;   --image-pull-progress-deadline=2m \\
</span><span class="s">&gt;   --kubeconfig=/var/lib/kubelet/kubeconfig \\
</span><span class="s">&gt;   --network-plugin=cni \\
</span><span class="s">&gt;   --register-node=true \\
</span><span class="s">&gt;   --v=2
</span><span class="s">&gt; Restart=on-failure
</span><span class="s">&gt; RestartSec=5
</span><span class="s">&gt;
</span><span class="s">&gt; [Install]
</span><span class="s">&gt; WantedBy=multi-user.target
</span><span class="s">&gt; EOF</span>
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kubelet
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/kubernetes/kubernetes
<span class="nv">After</span><span class="o">=</span>containerd.service
<span class="nv">Requires</span><span class="o">=</span>containerd.service

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/kubelet <span class="se">\
</span><span class="se"></span>  --config<span class="o">=</span>/var/lib/kubelet/kubelet-config.yaml <span class="se">\
</span><span class="se"></span>  --container-runtime<span class="o">=</span>remote <span class="se">\
</span><span class="se"></span>  --container-runtime-endpoint<span class="o">=</span>unix:///var/run/containerd/containerd.sock <span class="se">\
</span><span class="se"></span>  --image-pull-progress-deadline<span class="o">=</span>2m <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>/var/lib/kubelet/kubeconfig <span class="se">\
</span><span class="se"></span>  --network-plugin<span class="o">=</span>cni <span class="se">\
</span><span class="se"></span>  --register-node<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --v<span class="o">=</span><span class="m">2</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">5</span>

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
yuendo@worker-0:~$ sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig
yuendo@worker-0:~$ cat <span class="s">&lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml
</span><span class="s">&gt; kind: KubeProxyConfiguration
</span><span class="s">&gt; apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span><span class="s">&gt; clientConnection:
</span><span class="s">&gt;   kubeconfig: &#34;/var/lib/kube-proxy/kubeconfig&#34;
</span><span class="s">&gt; mode: &#34;iptables&#34;
</span><span class="s">&gt; clusterCIDR: &#34;10.200.0.0/16&#34;
</span><span class="s">&gt; EOF</span>
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
clientConnection:
  kubeconfig: <span class="s2">&#34;/var/lib/kube-proxy/kubeconfig&#34;</span>
mode: <span class="s2">&#34;iptables&#34;</span>
clusterCIDR: <span class="s2">&#34;10.200.0.0/16&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Kubernetes proxyについても設定ファイルを作成していく。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">yuendo@worker-0:~$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service
</span><span class="s">&gt; [Unit]
</span><span class="s">&gt; Description=Kubernetes Kube Proxy
</span><span class="s">&gt; Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s">&gt;
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; ExecStart=/usr/local/bin/kube-proxy \\
</span><span class="s">&gt;   --config=/var/lib/kube-proxy/kube-proxy-config.yaml
</span><span class="s">&gt; Restart=on-failure
</span><span class="s">&gt; RestartSec=5
</span><span class="s">&gt;
</span><span class="s">&gt; [Install]
</span><span class="s">&gt; WantedBy=multi-user.target
</span><span class="s">&gt; EOF</span>
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kube Proxy
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/kubernetes/kubernetes

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/kube-proxy <span class="se">\
</span><span class="se"></span>  --config<span class="o">=</span>/var/lib/kube-proxy/kube-proxy-config.yaml
  <span class="nv">Restart</span><span class="o">=</span>on-failure
  <span class="nv">RestartSec</span><span class="o">=</span><span class="m">5</span>

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></td></tr></table>
</div>
</div><p>設定ファイルが揃ったのでWorker Serviceを起動する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">yuendo@worker-0:~$ sudo systemctl daemon-reload
yuendo@worker-0:~$ sudo systemctl <span class="nb">enable</span> containerd kubelet kube-proxy
Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /etc/systemd/system/containerd.service.
Created symlink /etc/systemd/system/multi-user.target.wants/kubelet.service → /etc/systemd/system/kubelet.service.
Created symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /etc/systemd/system/kube-proxy.service.
yuendo@worker-0:~$ sudo systemctl start containerd kubelet kube-proxy
</code></pre></td></tr></table>
</div>
</div><p>コントローラー経由でkubectlコマンドを実行し、worker nodeの情報が表示されればOK。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ gcloud compute ssh controller-0 <span class="se">\
</span><span class="se"></span>&gt; --command <span class="s2">&#34;kubectl get nodes --kubeconfig admin.kubeconfig&#34;</span>
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
NAME       STATUS   ROLES    AGE    VERSION
worker-0   Ready    &lt;none&gt;   112s   v1.15.3
worker-1   Ready    &lt;none&gt;   112s   v1.15.3
worker-2   Ready    &lt;none&gt;   112s   v1.15.3
</code></pre></td></tr></table>
</div>
</div><h4 id="configuring-kubectl-for-remote-access">Configuring kubectl for Remote Access</h4>
<p>このセクションではadminユーザーでkubectlコマンドを使用するためのkubeconfigファイルを作成していく。</p>
<p>kubeconfigはKubernetes API Serverにアクセスする必要がある。
Kubernetes API Serverにアクセスする際は(高可用性実現のため)前段にある外部向けLBのIPアドレスが利用される。</p>
<p>では早速Kubeconfigを作っていく。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># external Load BalancerのIPアドレスを取得</span>
$ <span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="o">=</span><span class="k">$(</span>gcloud compute addresses describe kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span> <span class="se">\
</span><span class="se"></span>&gt;   --format <span class="s1">&#39;value(address)&#39;</span><span class="k">)</span>

<span class="c1"># Kubernetesクラスタをセット</span>
$ kubectl config set-cluster kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --certificate-authority<span class="o">=</span>ca.pem <span class="se">\
</span><span class="se"></span>&gt;   --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>&gt;   --server<span class="o">=</span>https://<span class="si">${</span><span class="nv">KUBERNETES_PUBLIC_ADDRESS</span><span class="si">}</span>:6443
Cluster <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> set.

<span class="c1"># キーペアをセット</span>
$ kubectl config set-credentials admin <span class="se">\
</span><span class="se"></span>&gt;   --client-certificate<span class="o">=</span>admin.pem <span class="se">\
</span><span class="se"></span>&gt;   --client-key<span class="o">=</span>admin-key.pem
User <span class="s2">&#34;admin&#34;</span> set.

<span class="c1"># コンテキストをセット</span>
$ kubectl config set-context kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --cluster<span class="o">=</span>kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;   --user<span class="o">=</span>admin
Context <span class="s2">&#34;kubernetes-the-hard-way&#34;</span> created.

<span class="c1"># コンテキストを作成した&#34;kubernetes-the-hard-way&#34;に変更</span>
$ kubectl config use-context kubernetes-the-hard-way
Switched to context <span class="s2">&#34;kubernetes-the-hard-way&#34;</span>.
</code></pre></td></tr></table>
</div>
</div><p>作成したkubeconfigの動作確認。<br>
これでようやく自PCからKubernetesクラスタに自由にkubectlできるようになった。やった。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 各コンポーネントのステータス確認</span>
$ kubectl get componentstatuses
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok
controller-manager   Healthy   ok
etcd-1               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span><span class="o">}</span>
etcd-2               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span><span class="o">}</span>
etcd-0               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span><span class="o">}</span>

<span class="c1"># node確認</span>
$ kubectl get nodes
NAME       STATUS   ROLES    AGE   VERSION
worker-0   Ready    &lt;none&gt;   11h   v1.15.3
worker-1   Ready    &lt;none&gt;   11h   v1.15.3
worker-2   Ready    &lt;none&gt;   11h   v1.15.3
</code></pre></td></tr></table>
</div>
</div><h4 id="provisioning-pod-network-routes">Provisioning Pod Network Routes</h4>
<p>Podには稼働nodeに割り当てられたPod CIDR Rangeの中からIPアドレスが付与される。
そのためルーティングが実装されていないと他のnode上のPodと通信できない。</p>
<p>このセクションでは各Worker nodeに対してPod CIDR RangeがnodeのIPアドレスにマッピングされるような経路を設定する。
※他にも実装方法があるようだがここでは触れないことにする。</p>
<p>まずは<code>kubernetes-the-hard-way</code> VPC Networkでルーティング設定するために必要な情報を収集する。
必要な情報というのは各Worker nodeのinternal IPアドレスとPod CIDR Rangeで、取得するコマンドは以下のとおり。
gcloudコマンドで抽出しているのは各nodeのIPアドレスとmetadataの1つ目。
Worker nodeを作るときにmedatadaとしてPod CIDRを指定しているのでそれが参照される。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="k">for</span> instance in worker-0 worker-1 worker-2<span class="p">;</span> <span class="k">do</span>
&gt;   gcloud compute instances describe <span class="si">${</span><span class="nv">instance</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;     --format <span class="s1">&#39;value[separator=&#34; &#34;](networkInterfaces[0].networkIP,metadata.items[0].value)&#39;</span>
&gt; <span class="k">done</span>
10.240.0.20 10.200.0.0/24
10.240.0.21 10.200.1.0/24
10.240.0.22 10.200.2.0/24
</code></pre></td></tr></table>
</div>
</div><p>確認した情報をもとにルーティングを設定していく。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ルーティング定義作成</span>
$ <span class="k">for</span> i in <span class="m">0</span> <span class="m">1</span> 2<span class="p">;</span> <span class="k">do</span>
&gt;   gcloud compute routes create kubernetes-route-10-200-<span class="si">${</span><span class="nv">i</span><span class="si">}</span>-0-24 <span class="se">\
</span><span class="se"></span>&gt;     --network kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt;     --next-hop-address 10.240.0.2<span class="si">${</span><span class="nv">i</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;     --destination-range 10.200.<span class="si">${</span><span class="nv">i</span><span class="si">}</span>.0/24
&gt; <span class="k">done</span>
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/routes/kubernetes-route-10-200-0-0-24<span class="o">]</span>.
NAME                            NETWORK                  DEST_RANGE     NEXT_HOP     PRIORITY
kubernetes-route-10-200-0-0-24  kubernetes-the-hard-way  10.200.0.0/24  10.240.0.20  <span class="m">1000</span>
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/routes/kubernetes-route-10-200-1-0-24<span class="o">]</span>.
NAME                            NETWORK                  DEST_RANGE     NEXT_HOP     PRIORITY
kubernetes-route-10-200-1-0-24  kubernetes-the-hard-way  10.200.1.0/24  10.240.0.21  <span class="m">1000</span>
Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/routes/kubernetes-route-10-200-2-0-24<span class="o">]</span>.
NAME                            NETWORK                  DEST_RANGE     NEXT_HOP     PRIORITY
kubernetes-route-10-200-2-0-24  kubernetes-the-hard-way  10.200.2.0/24  10.240.0.22  <span class="m">1000</span>

<span class="c1"># ルーティング定義の確認</span>
$ gcloud compute routes list --filter <span class="s2">&#34;network: kubernetes-the-hard-way&#34;</span>
NAME                            NETWORK                  DEST_RANGE     NEXT_HOP                  PRIORITY
default-route-6b78d5656e1f61f7  kubernetes-the-hard-way  10.240.0.0/24  kubernetes-the-hard-way   <span class="m">1000</span>
default-route-f3bff7647d191b86  kubernetes-the-hard-way  0.0.0.0/0      default-internet-gateway  <span class="m">1000</span>
kubernetes-route-10-200-0-0-24  kubernetes-the-hard-way  10.200.0.0/24  10.240.0.20               <span class="m">1000</span>
kubernetes-route-10-200-1-0-24  kubernetes-the-hard-way  10.200.1.0/24  10.240.0.21               <span class="m">1000</span>
kubernetes-route-10-200-2-0-24  kubernetes-the-hard-way  10.200.2.0/24  10.240.0.22               <span class="m">1000</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="deploying-the-dns-cluster-add-on">Deploying the DNS Cluster Add-on</h4>
<p>次に、Kubernetesクラスタ上で稼働するアプリケーションに対してDNSベースのサービスディスカバリ機能を提供するためのDNS Add-onを実装していく。
<code>CoreDNS</code>というものを使用するとのこと。関連コンポーネントがどんどん増えていって大変。</p>
<p>まずは<code>coredns</code>クラスタアドオンをデプロイ。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># corednsのデプロイ</span>
$ kubectl apply -f https://storage.googleapis.com/kubernetes-the-hard-way/coredns.yaml
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created

<span class="c1"># corednsがデプロイされたことを確認</span>
<span class="c1"># → だめ。READYにならない。</span>
$ kubectl get pods -l k8s-app<span class="o">=</span>kube-dns -n kube-system
NAME                     READY   STATUS    RESTARTS   AGE
coredns-5fb99965-llsk5   0/1     Running   <span class="m">0</span>          36s
coredns-5fb99965-rnc2m   0/1     Running   <span class="m">0</span>          36s
</code></pre></td></tr></table>
</div>
</div><p>corednsの稼働確認として、<code>busybox</code>deploymentを作成して、その中のPodの中で名前解決してみる。
が、そもそもcorednsがREADYにならないので名前解決できない。
調べてみるとcorednsがうまく起動しないのはメジャーな症状のようだが、細かく調べていく時間がないので仕方なくスキップする。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># busybox deploymentの作成</span>
$ kubectl run --generator<span class="o">=</span>run-pod/v1 busybox --image<span class="o">=</span>busybox:1.28 --command -- sleep <span class="m">3600</span>
pod/busybox created

<span class="c1"># Pod名の確認、変数に格納</span>
$ kubectl get pods -l <span class="nv">run</span><span class="o">=</span>busybox
NAME      READY   STATUS    RESTARTS   AGE
busybox   1/1     Running   <span class="m">0</span>          17s
$ <span class="nv">POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods -l <span class="nv">run</span><span class="o">=</span>busybox -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.items[0].metadata.name}&#34;</span><span class="k">)</span>

<span class="c1"># 作ったPodでkubernetesの名前解決を試みる</span>
$ kubectl <span class="nb">exec</span> -ti <span class="nv">$POD_NAME</span> -- nslookup kubernetes
Server:    10.32.0.10
Address 1: 10.32.0.10

nslookup: can<span class="s1">&#39;t resolve &#39;</span>kubernetes<span class="err">&#39;</span>
<span class="nb">command</span> terminated with <span class="nb">exit</span> code <span class="m">1</span>
<span class="c1"># 解決できない！！</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="smoke-test">Smoke Test</h4>
<p>この章では作成したKubernetesクラスタが正しく動作することを確認する。
いよいよ大詰めといった感じ。</p>
<p>まずは「データの暗号化」ができることを確認する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># generic secretの作成(dataをスペルミスしちゃった)</span>
$ kubectl create secret generic kubernetes-the-hard-way <span class="se">\
</span><span class="se"></span>&gt; --from-literal<span class="o">=</span><span class="s2">&#34;mykey=mydate&#34;</span>
secret/kubernetes-the-hard-way created

<span class="c1"># 作成したsecret &#34;kubernetes-the-hard-way&#34; のhexdumpを表示</span>
$ gcloud compute ssh controller-0 <span class="se">\
</span><span class="se"></span>&gt;   --command <span class="s2">&#34;sudo ETCDCTL_API=3 etcdctl get \
</span><span class="s2">&gt;   --endpoints=https://127.0.0.1:2379 \
</span><span class="s2">&gt;   --cacert=/etc/etcd/ca.pem \
</span><span class="s2">&gt;   --cert=/etc/etcd/kubernetes.pem \
</span><span class="s2">&gt;   --key=/etc/etcd/kubernetes-key.pem \
</span><span class="s2">&gt;   /registry/secrets/default/kubernetes-the-hard-way | hexdump -C&#34;</span>
Enter passphrase <span class="k">for</span> key <span class="s1">&#39;/Users/yuendo/.ssh/google_compute_engine&#39;</span>:
bash: warning: setlocale: LC_ALL: cannot change locale <span class="o">(</span>ja_JP.UTF-8<span class="o">)</span>
<span class="m">00000000</span>  2f <span class="m">72</span> <span class="m">65</span> <span class="m">67</span> <span class="m">69</span> <span class="m">73</span> <span class="m">74</span> <span class="m">72</span>  <span class="m">79</span> 2f <span class="m">73</span> <span class="m">65</span> <span class="m">63</span> <span class="m">72</span> <span class="m">65</span> <span class="m">74</span>  <span class="p">|</span>/registry/secret<span class="p">|</span>
<span class="m">00000010</span>  <span class="m">73</span> 2f <span class="m">64</span> <span class="m">65</span> <span class="m">66</span> <span class="m">61</span> <span class="m">75</span> 6c  <span class="m">74</span> 2f 6b <span class="m">75</span> <span class="m">62</span> <span class="m">65</span> <span class="m">72</span> 6e  <span class="p">|</span>s/default/kubern<span class="p">|</span>
<span class="m">00000020</span>  <span class="m">65</span> <span class="m">74</span> <span class="m">65</span> <span class="m">73</span> 2d <span class="m">74</span> <span class="m">68</span> <span class="m">65</span>  2d <span class="m">68</span> <span class="m">61</span> <span class="m">72</span> <span class="m">64</span> 2d <span class="m">77</span> <span class="m">61</span>  <span class="p">|</span>etes-the-hard-wa<span class="p">|</span>
<span class="m">00000030</span>  <span class="m">79</span> 0a 6b <span class="m">38</span> <span class="m">73</span> 3a <span class="m">65</span> 6e  <span class="m">63</span> 3a <span class="m">61</span> <span class="m">65</span> <span class="m">73</span> <span class="m">63</span> <span class="m">62</span> <span class="m">63</span>  <span class="p">|</span>y.k8s:enc:aescbc<span class="p">|</span>
<span class="m">00000040</span>  3a <span class="m">76</span> <span class="m">31</span> 3a 6b <span class="m">65</span> <span class="m">79</span> <span class="m">31</span>  3a ed 7c <span class="m">14</span> <span class="m">32</span> ee <span class="m">19</span> <span class="m">15</span>  <span class="p">|</span>:v1:key1:.<span class="p">|</span>.2...<span class="p">|</span>
<span class="m">00000050</span>  f9 4d 7b <span class="m">84</span> <span class="m">62</span> 3f <span class="m">80</span> c0  af c3 a7 d8 ba <span class="m">37</span> <span class="m">22</span> ff  <span class="p">|</span>.M<span class="o">{</span>.b?.......7<span class="s2">&#34;.|
</span><span class="s2">00000060  0e 75 d8 7d b0 a8 2b 9a  4f 9d e2 28 91 45 b4 97  |.u.}..+.O..(.E..|
</span><span class="s2">00000070  7f 8f 38 74 38 82 55 f1  88 0f 2d e0 e1 cc e5 d4  |..8t8.U...-.....|
</span><span class="s2">00000080  8e 2f b4 d6 13 60 8a 29  3d f3 7c 64 53 69 85 85  |./...`.)=.|dSi..|
</span><span class="s2">00000090  a2 15 0e 43 b0 b8 14 a0  e2 7b b6 08 6b 70 e4 fe  |...C.....{..kp..|
</span><span class="s2">000000a0  28 e7 e1 89 5b a1 f7 f7  b5 57 8a ef 35 7d a9 97  |(...[....W..5}..|
</span><span class="s2">000000b0  3d 2b b6 a7 92 3a 0b 46  d6 c1 b5 2b 1b 16 69 b9  |=+...:.F...+..i.|
</span><span class="s2">000000c0  e1 5c 63 27 6e 15 cb 94  0b 2c 39 57 79 8e 6b f2  |.\c&#39;n....,9Wy.k.|
</span><span class="s2">000000d0  3f 60 7a 6d 1d f3 7e c1  ed eb df cd 9c e4 5f b3  |?`zm..~......._.|
</span><span class="s2">000000e0  5c ed 89 61 54 10 a7 32  18 0a                    |\..aT..2..|
</span><span class="s2">000000ea
</span></code></pre></td></tr></table>
</div>
</div><p>次はDeploymentsの確認。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># nginxのdeploymentを作成</span>
$ kubectl create deployment nginx --image<span class="o">=</span>nginx
deployment.apps/nginx created

<span class="c1"># deploymentから作成されたpodを確認</span>
$ kubectl get pods -l <span class="nv">app</span><span class="o">=</span>nginx
NAME                     READY   STATUS    RESTARTS   AGE
nginx-554b9c67f9-bl7p4   1/1     Running   <span class="m">0</span>          18s
</code></pre></td></tr></table>
</div>
</div><p>次はPort Forwardingの確認。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># nginxのpodのフルネーム確認</span>
$ <span class="nv">POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods -l <span class="nv">app</span><span class="o">=</span>nginx -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.items[0].metadata.name}&#34;</span><span class="k">)</span>

<span class="c1"># podの80番ポートをローカルの8080番に紐付け</span>
$ kubectl port-forward <span class="nv">$POD_NAME</span> 8080:80
Forwarding from 127.0.0.1:8080 -&gt; <span class="m">80</span>
Forwarding from <span class="o">[</span>::1<span class="o">]</span>:8080 -&gt; <span class="m">80</span>
Handling connection <span class="k">for</span> <span class="m">8080</span>

<span class="c1"># 別セッションでローカルの8080ポートにアクセスしてフォワーディングされることを確認</span>
$ curl --head http://127.0.0.1:8080
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.17.10
Date: Fri, <span class="m">15</span> May <span class="m">2020</span> 17:58:26 GMT
Content-Type: text/html
Content-Length: <span class="m">612</span>
Last-Modified: Tue, <span class="m">14</span> Apr <span class="m">2020</span> 14:19:26 GMT
Connection: keep-alive
ETag: <span class="s2">&#34;5e95c66e-264&#34;</span>
Accept-Ranges: bytes
</code></pre></td></tr></table>
</div>
</div><p>次にログ確認。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># podのログを表示</span>
$ kubectl logs <span class="nv">$POD_NAME</span>
127.0.0.1 - - <span class="o">[</span>15/May/2020:17:58:26 +0000<span class="o">]</span> <span class="s2">&#34;HEAD / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;curl/7.54.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>次はコンテナ上でコマンド実行できることを確認する。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># pod上で&#34;nginx -v&#34;を実行</span>
$ kubectl <span class="nb">exec</span> -ti <span class="nv">$POD_NAME</span> -- nginx -v
nginx version: nginx/1.17.10
</code></pre></td></tr></table>
</div>
</div><p>最後にサービス機能を使ってアプリケーションを外部に公開してみる。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 公開設定</span>
$ kubectl expose deployment nginx --port <span class="m">80</span> --type NodePort
service/nginx exposed
kubernetes-the-hard-way $ <span class="nv">NODE_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl get svc nginx <span class="se">\
</span><span class="se"></span>&gt;   --output<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{range .spec.ports[0]}{.nodePort}&#39;</span><span class="k">)</span>

<span class="c1"># ファイアウォール設定を追加</span>
$ gcloud compute firewall-rules create kubernetes-the-hard-way-allow-nginx-service <span class="se">\
</span><span class="se"></span>&gt;   --allow<span class="o">=</span>tcp:<span class="si">${</span><span class="nv">NODE_PORT</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>&gt;   --network kubernetes-the-hard-way
Creating firewall...⠶Created <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-nginx-service<span class="o">]</span>.
Creating firewall...done.
NAME                                         NETWORK                  DIRECTION  PRIORITY  ALLOW      DENY  DISABLED
kubernetes-the-hard-way-allow-nginx-service  kubernetes-the-hard-way  INGRESS    <span class="m">1000</span>      tcp:31766        False

<span class="c1"># 外部公開用のIPアドレスを確認</span>
$ <span class="nv">EXTERNAL_IP</span><span class="o">=</span><span class="k">$(</span>gcloud compute instances describe worker-0 <span class="se">\
</span><span class="se"></span>&gt;   --format <span class="s1">&#39;value(networkInterfaces[0].accessConfigs[0].natIP)&#39;</span><span class="k">)</span>

<span class="c1"># 接続確認</span>
<span class="c1"># → だめだ、つながらない。どこだろう。もういいや</span>
$ curl -I http://<span class="si">${</span><span class="nv">EXTERNAL_IP</span><span class="si">}</span>:<span class="si">${</span><span class="nv">NODE_PORT</span><span class="si">}</span>
curl: <span class="o">(</span>7<span class="o">)</span> Failed to connect to 35.247.6.238 port 31766: Connection refused
</code></pre></td></tr></table>
</div>
</div><p>最後の最後がうまく接続できなかった、、、dnsがうまく上がっていないところと関係しているのかもしれない。
もしくはexposeがうまく機能していないのか。。
いずれにしてもここからさきはCKA的な操作を理解していないとPDができないので、
一旦このチュートリアルは引き上げていきたいと思う。</p>
<p>(GCPの無料分があと少しで終了するから引き上げなきゃいけないだけ。。)</p>
<h4 id="cleaning-up">Cleaning Up</h4>
<p>ここまでのチュートリアルで作成してきたリソース群を削除していく。</p>
<p>コンピュートリソースの削除。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># controller-0,1,2とworker-0,1,2を削除</span>
$ gcloud -q compute instances delete <span class="se">\
</span><span class="se"></span>&gt; controller-0 controller-1 controller-2 <span class="se">\
</span><span class="se"></span>&gt; worker-0 worker-1 worker-2 <span class="se">\
</span><span class="se"></span>&gt; --zone <span class="k">$(</span>gcloud config get-value compute/zone<span class="k">)</span>
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/instances/worker-2<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/instances/worker-0<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/instances/controller-0<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/instances/controller-1<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/instances/controller-2<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/zones/us-west1-c/instances/worker-1<span class="o">]</span>.

Updates are available <span class="k">for</span> some Cloud SDK components.  To install them,
please run:
  $ gcloud components update
</code></pre></td></tr></table>
</div>
</div><p>外部用のLBの削除。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ポートフォワーディングのルール削除</span>
$ gcloud -q compute forwarding-rules delete kubernetes-forwarding-rule <span class="se">\
</span><span class="se"></span>&gt; --region <span class="k">$(</span>gcloud config get-value compute/region<span class="k">)</span>
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/forwardingRules/kubernetes-forwarding-rule<span class="o">]</span>.

<span class="c1"># ターゲットプール削除</span>
$ gcloud -q compute target-pools delete kubernetes-target-pool
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/targetPools/kubernetes-target-pool<span class="o">]</span>.

<span class="c1"># http-health-checks削除</span>
$ gcloud -q compute http-health-checks delete kubernetes
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/httpHealthChecks/kubernetes<span class="o">]</span>.

<span class="c1"># 固定IPアドレス削除</span>
$ gcloud -q compute addresses delete kubernetes-the-hard-way
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/addresses/kubernetes-the-hard-way<span class="o">]</span>.

<span class="c1"># ファイアウォールのルール削除</span>
$ gcloud -q compute firewall-rules delete <span class="se">\
</span><span class="se"></span>&gt; kubernetes-the-hard-way-allow-nginx-service <span class="se">\
</span><span class="se"></span>&gt; kubernetes-the-hard-way-allow-internal <span class="se">\
</span><span class="se"></span>&gt; kubernetes-the-hard-way-allow-external <span class="se">\
</span><span class="se"></span>&gt; kubernetes-the-hard-way-allow-health-check
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-nginx-service<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-external<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-internal<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/firewalls/kubernetes-the-hard-way-allow-health-check<span class="o">]</span>.

<span class="c1"># ルーティング設定削除</span>
$ gcloud -q compute routes delete <span class="se">\
</span><span class="se"></span>&gt; kubernetes-route-10-200-0-0-24 <span class="se">\
</span><span class="se"></span>&gt; kubernetes-route-10-200-1-0-24 <span class="se">\
</span><span class="se"></span>&gt; kubernetes-route-10-200-2-0-24
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/routes/kubernetes-route-10-200-0-0-24<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/routes/kubernetes-route-10-200-1-0-24<span class="o">]</span>.
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/routes/kubernetes-route-10-200-2-0-24<span class="o">]</span>.

<span class="c1"># サブネット、ネットワーク削除</span>
$ gcloud -q compute networks subnets delete kubernetes
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/regions/us-west1/subnetworks/kubernetes<span class="o">]</span>.
$ gcloud -q compute networks delete kubernetes-the-hard-way
Deleted <span class="o">[</span>https://www.googleapis.com/compute/v1/projects/rising-capsule-272923/global/networks/kubernetes-the-hard-way<span class="o">]</span>.
</code></pre></td></tr></table>
</div>
</div><p>おわり。</p>
<p>HardWayをやってみた感想は後日書くこととする。ひとまずおしまい。</p>

        </div>
    </article>

                </div>
            </div>
        </main>
        <footer class="m-global-footer">
            <span class="a-copy-right">
    Copyright 2020
    UNCHAIN-ENDO
    All rights reserved.
</span>


        </footer>
    </body>
</html>
